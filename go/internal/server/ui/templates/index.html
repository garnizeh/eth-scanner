{{template "base" .}}

{{define "title"}}Overview{{end}}

{{define "content"}}
<div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
        <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight">Overview</h2>
        <p class="mt-1 text-sm text-gray-500">Real-time distributed Ethereum brute-force monitoring.</p>
    </div>

    <div class="flex items-center space-x-2 bg-green-50 border border-green-100 rounded-lg px-3 py-1.5 shadow-sm">
        <span class="relative flex h-3 w-3">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
        </span>
        <span class="text-xs font-bold text-green-800 uppercase tracking-widest">Live Monitoring</span>
    </div>
</div>

<div class="space-y-6">
    <!-- Info Box (System Status) -->
    <div class="bg-blue-600 rounded-xl shadow-lg p-6 text-white overflow-hidden relative">
        <div class="relative z-10">
            <h3 class="text-xl font-bold mb-2 tracking-tight">System Status</h3>
            <p class="text-blue-100 text-sm max-w-2xl leading-relaxed">
                The master node is actively managing worker ranges. New jobs are distributed based on worker reported
                throughput. Check the Workers tab for individual performance metrics.
            </p>
        </div>
        <!-- Decorative SVG element -->
        <svg class="absolute right-0 bottom-0 text-blue-500 opacity-20 w-48 h-48 -mr-12 -mb-12 rotate-12"
            fill="currentColor" viewBox="0 0 200 200">
            <path
                d="M43.3,165.7c-17.1-17.1-17.1-44.8,0-61.9l61.9-61.9c17.1-17.1,44.8-17.1,61.9,0s17.1,44.8,0,61.9l-61.9,61.9 C88,182.7,60.3,182.7,43.3,165.7z" />
        </svg>
    </div>

    <!-- Secondary Stats (Total Workers, Active Jobs, Global Throughput) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div
            class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between transition hover:shadow-md">
            <div>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Total Workers</h3>
                <p id="total-workers" class="text-4xl font-black text-blue-600 tracking-tighter">{{ formatCount
                    .TotalWorkers }}</p>
            </div>
            <div
                class="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between text-[11px] font-bold uppercase tracking-wider">
                <span class="text-gray-400">Lifetime registered</span>
                <a href="/dashboard/workers" class="text-blue-500 hover:text-blue-700 transition">View list â†’</a>
            </div>
        </div>

        <div
            class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between transition hover:shadow-md">
            <div>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Active Jobs</h3>
                <p id="active-jobs" class="text-4xl font-black text-green-600 tracking-tighter">{{ .ProcessingJobCount
                    }}
                </p>
            </div>
            <div
                class="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between text-[11px] font-bold uppercase tracking-wider">
                <span class="text-gray-400">Currently processing</span>
                <span class="text-green-500 tracking-widest">Running</span>
            </div>
        </div>

        <div
            class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between transition hover:shadow-md">
            <div>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Global Throughput</h3>
                <p id="global-throughput" class="text-4xl font-black text-purple-600 tracking-tighter">{{ printf "%.1f"
                    .GlobalKeysPerSecond }} k/s</p>
            </div>
            <div
                class="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between text-[11px] font-bold uppercase tracking-wider">
                <span class="text-gray-400">Total keys/sec</span>
                <span class="text-purple-500 tracking-widest text-right">Aggregated Fleet</span>
            </div>
        </div>
    </div>

    <!-- Live Stats Grid (updated via WebSocket: Live Active Workers, Keys Scanned, Completed Batches) -->
    <div id="fleet-stats" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {{template "fleet-stats-content" .}}
    </div>

    <!-- Live Throughput Chart -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 overflow-hidden relative">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest leading-none mb-1">Live Throughput
                </h3>
                <p class="text-[10px] text-gray-500 font-medium">REAL-TIME KEYS PER SECOND (10m WINDOW, UTC TIME)</p>
            </div>
            <div class="flex items-center space-x-2">
                <span class="inline-block h-2 w-2 rounded-full bg-purple-500"></span>
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Fleet Aggregate</span>
            </div>
        </div>
        <div id="throughput-chart" class="w-full h-48 sm:h-64"></div>
        <!-- Hidden data bridge for HTMX/Chart -->
        <div id="bridge-container">
            <div id="throughput-bridge" class="hidden" hx-swap-oob="true" {{dataFloatAttr "throughput"
                .GlobalKeysPerSecond 1}} {{dataAttr "time" .NowTimestamp}}></div>
        </div>
    </div>

    <!-- Active Workers Table (Active Fleet Status) - Moved up for better visibility -->
    <div id="active-workers-container" class="transition-all duration-500">
        {{template "active-workers" .}}
    </div>

    <!-- Prefix Progress (updated via WebSocket) -->
    <div class="space-y-4">
        <div class="flex items-center justify-between">
            <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest">Active Search Prefixes</h3>
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest opacity-60">Grouped by
                prefix_28</span>
        </div>
        <div id="prefix-progress-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {{template "prefix-progress-content" .}}
        </div>
    </div>
</div>

<script>
    (function () {
        let chart;
        const data = [[], []];

        // Seed initial history data to avoid empty chart on load
        const history = JSON.parse('{{ json .RecentHistory }}');
        if (history && history.length > 0) {
            // Sort history by time ascended
            const pts = history
                .filter(h => h.keys_per_second?.Valid)
                .map(h => ({
                    t: Math.floor(new Date(h.finished_at).getTime() / 1000),
                    k: h.keys_per_second.Float64
                }))
                .sort((a, b) => a.t - b.t);

            pts.forEach(p => {
                data[0].push(p.t);
                data[1].push(p.k);
            });
        }

        function initChart() {
            const container = document.getElementById('throughput-chart');
            if (!container) return;

            const opts = {
                id: "chart1",
                width: container.offsetWidth,
                height: container.offsetHeight,
                cursor: { show: false },
                select: { show: false },
                legend: { show: false },
                scales: {
                    x: {
                        time: true,
                        tzDate: ts => uPlot.tzDate(new Date(ts * 1000), 'UTC'),
                    },
                    y: {
                        auto: true,
                        range: (u, min, max) => [0, max * 1.1 + 10]
                    }
                },
                series: [
                    {},
                    {
                        stroke: "#8b5cf6",
                        width: 2,
                        fill: "rgba(139, 92, 246, 0.1)",
                        points: { show: false }
                    },
                ],
                axes: [
                    {
                        stroke: "#94a3b8",
                        grid: { stroke: "#f1f5f9", width: 1 },
                        ticks: { stroke: "#cbd5e1", width: 1 },
                        values: (u, vals) => vals.map(v => {
                            const d = new Date(v * 1000);
                            return d.getUTCHours().toString().padStart(2, '0') + ":" +
                                d.getUTCMinutes().toString().padStart(2, '0') + ":" +
                                d.getUTCSeconds().toString().padStart(2, '0');
                        })
                    },
                    {
                        stroke: "#94a3b8",
                        grid: { stroke: "#f1f5f9", width: 1 },
                        ticks: { stroke: "#cbd5e1", width: 1 },
                        values: (u, vals) => vals.map(v => v >= 1000 ? (v / 1000).toFixed(1) + "k" : v)
                    }
                ]
            };

            chart = new uPlot(opts, data, container);

            window.addEventListener("resize", () => {
                chart.setSize({
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                });
            });
        }

        function updateChart() {
            const bridge = document.getElementById('throughput-bridge');
            if (!bridge || !chart) return;

            const throughput = parseFloat(bridge.getAttribute('data-throughput')) || 0;
            const time = parseInt(bridge.getAttribute('data-time')) || Math.floor(Date.now() / 1000);

            // Avoid duplicate points from same bridge update
            if (data[0].length > 0 && data[0][data[0].length - 1] >= time) {
                return;
            }

            data[0].push(time);
            data[1].push(throughput);

            const windowSize = 600; // 10 minutes
            const minTime = time - windowSize;

            while (data[0].length > 0 && data[0][0] < minTime) {
                data[0].shift();
                data[1].shift();
            }

            chart.setData(data);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initChart();
                updateChart();
            });
        } else {
            initChart();
            updateChart();
        }

        const observer = new MutationObserver(() => updateChart());
        const bridgeContainer = document.getElementById('bridge-container');
        if (bridgeContainer) {
            observer.observe(bridgeContainer, { childList: true, subtree: true, attributes: true });
        }
    })();
</script>
{{end}}