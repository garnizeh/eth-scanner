# P04-T090: Create POST /api/v1/jobs/{id}/complete handler

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T010, P02-T040  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the job completion endpoint that allows workers to mark a job as finished after scanning the entire nonce range. This transitions the job to `completed` status and validates that the worker scanned the full range.

---

## Acceptance Criteria

- [ ] Handler `handleJobComplete` implemented
- [ ] Accepts POST request to `/api/v1/jobs/{id}/complete`
- [ ] Request body: `{"worker_id": "...", "final_nonce": 999999, "keys_scanned": 1000000}`
- [ ] Validates job exists and is in `processing` status
- [ ] Validates worker_id matches job's assigned worker
- [ ] Validates final_nonce equals job's nonce_end (enforced in P04-T100)
- [ ] Updates job: status='completed', current_nonce=final_nonce, completed_at=NOW() UTC
- [ ] Returns 200 OK with completed job
- [ ] Returns 403 Forbidden if worker_id mismatch
- [ ] Returns 400 Bad Request if validation fails
- [ ] Route registered in `routes.go`

---

## Implementation Notes

**Key Points:**
- Reference SDD: Job lifecycle — pending → processing → completed
- Completion means worker scanned nonce_start to nonce_end inclusive
- final_nonce should equal nonce_end (validation in P04-T100)
- Set completed_at timestamp (UTC)

**Request Schema:**
```json
{
  "worker_id": "worker-pc-001",
  "final_nonce": 999999,
  "keys_scanned": 1000000
}
```

**Response Schema:**
```json
{
  "job_id": 123,
  "status": "completed",
  "final_nonce": 999999,
  "keys_scanned": 1000000,
  "completed_at": "2026-02-15T15:30:00Z"
}
```

**SQL Update:**
```sql
UPDATE jobs 
SET status = 'completed', 
    current_nonce = ?, 
    keys_scanned = ?,
    completed_at = ?,
    updated_at = ?
WHERE id = ? AND worker_id = ? AND status = 'processing';
```

---

## Testing

- Test successful completion
- Test worker_id mismatch (403)
- Test completing already completed job (400)
- Test completing pending job (400)
- Test final_nonce validation (covered in P04-T100)

---

## References

- SDD: Section 5.1 — POST /api/v1/jobs/{job_id}/complete
- Database: `internal/database/queries.sql`
- Related: P04-T100 (final_nonce validation)
