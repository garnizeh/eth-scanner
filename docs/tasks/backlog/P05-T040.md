# P05-T040: Implement UpdateCheckpoint() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

## Description

Implement the `UpdateCheckpoint()` function in the worker client to periodically report scanning progress to the Master API. This function will send a PATCH request to `/api/v1/jobs/{job_id}/checkpoint` with the current nonce and keys scanned count.

## Acceptance Criteria

- [ ] `UpdateCheckpoint(ctx context.Context, jobID string, currentNonce uint32, keysScanned uint64)` function added to `Client`
- [ ] Function sends PATCH request to `/api/v1/jobs/{job_id}/checkpoint`
- [ ] Request includes API key in `X-API-Key` header
- [ ] Request body contains:
  - `worker_id` (string)
  - `current_nonce` (uint32)
  - `keys_scanned` (uint64)
- [ ] Response status 200 OK indicates success
- [ ] Context cancellation is respected
- [ ] Returns descriptive error for failure cases (404, 401, 409, etc.)
- [ ] URL path correctly substitutes `{job_id}` with actual job ID

## Implementation Notes

### Function Signature
```go
package worker

import "context"

func (c *Client) UpdateCheckpoint(ctx context.Context, jobID string, currentNonce uint32, keysScanned uint64) error {
    // Build request
    req := checkpointRequest{
        WorkerID:     c.workerID,
        CurrentNonce: currentNonce,
        KeysScanned:  keysScanned,
    }
    
    // Build path with job_id
    path := fmt.Sprintf("/api/v1/jobs/%s/checkpoint", jobID)
    
    // Make API call (no response body expected for 200 OK)
    err := c.doRequestWithContext(ctx, "PATCH", path, req, nil)
    if err != nil {
        return fmt.Errorf("checkpoint update failed: %w", err)
    }
    
    return nil
}

// Internal request type
type checkpointRequest struct {
    WorkerID     string `json:"worker_id"`
    CurrentNonce uint32 `json:"current_nonce"`
    KeysScanned  uint64 `json:"keys_scanned"`
}
```

### API Request Example
```json
PATCH /api/v1/jobs/01234567-89ab-cdef-0123-456789abcdef/checkpoint
X-API-Key: sk_test_1234567890abcdef
Content-Type: application/json

{
  "worker_id": "worker-pc-001",
  "current_nonce": 1234567890,
  "keys_scanned": 1234567890
}
```

### API Response Example (Success)
```
HTTP 200 OK
```

### API Response Example (Errors)
```json
HTTP 404 Not Found
{
  "error": "job not found"
}
```

```json
HTTP 409 Conflict
{
  "error": "worker_id mismatch",
  "message": "job is assigned to different worker"
}
```

```json
HTTP 400 Bad Request
{
  "error": "invalid current_nonce",
  "message": "current_nonce must be between nonce_start and nonce_end"
}
```

## Testing

```bash
cd /home/user/code/garnizeh/eth-scanner/go
go test ./internal/worker -v -run TestUpdateCheckpoint
```

### Test Cases
- Successful checkpoint update (200 OK)
- Job ID is correctly inserted into URL path
- Request body contains correct worker_id, current_nonce, keys_scanned
- X-API-Key header is included
- Context timeout cancels the request
- 404 error (job not found) returns error
- 409 error (worker_id mismatch) returns error
- 400 error (invalid nonce) returns error
- 401 error (missing/invalid API key) returns error

### Mock Server Test
```go
func TestUpdateCheckpoint(t *testing.T) {
    server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Verify method
        if r.Method != "PATCH" {
            t.Errorf("expected PATCH, got %s", r.Method)
        }
        
        // Verify path
        expectedPath := "/api/v1/jobs/test-job-123/checkpoint"
        if r.URL.Path != expectedPath {
            t.Errorf("expected %s, got %s", expectedPath, r.URL.Path)
        }
        
        // Verify API key
        if r.Header.Get("X-API-Key") != "test-key" {
            w.WriteHeader(http.StatusUnauthorized)
            return
        }
        
        // Verify body
        var req checkpointRequest
        json.NewDecoder(r.Body).Decode(&req)
        if req.WorkerID != "test-worker" {
            t.Errorf("expected worker_id test-worker, got %s", req.WorkerID)
        }
        if req.CurrentNonce != 12345 {
            t.Errorf("expected current_nonce 12345, got %d", req.CurrentNonce)
        }
        
        w.WriteHeader(http.StatusOK)
    }))
    defer server.Close()
    
    client := NewClient(&Config{
        APIURL:   server.URL,
        WorkerID: "test-worker",
        APIKey:   "test-key",
    })
    
    err := client.UpdateCheckpoint(context.Background(), "test-job-123", 12345, 12345)
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
}
```

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1.2: Update Checkpoint)
- Master API: P04-T070 (implements checkpoint endpoint)
- API key auth: P04-T160
- Related tasks: P05-T020 (Client), P06-T080 (periodic checkpointing)
