# P01-T050: Create scripts/init-db.sh Script

**Phase:** P01 - Project Foundation & Setup  
**Status:** Not Started  
**Priority:** Medium  
**Dependencies:** None  
**Estimated Effort:** Small (< 45 minutes)

---

## Description

Create a shell script `scripts/init-db.sh` that initializes the SQLite database by applying the schema from `docs/database/schema.sql`. This script provides a simple, repeatable way to set up the database for development and testing.

The script should be idempotent (safe to run multiple times) and create the database file in a standard location.

---

## Acceptance Criteria

- [ ] `scripts/init-db.sh` file exists and is executable
- [ ] Script applies schema from `docs/database/schema.sql`
- [ ] Script creates database at `data/ethscanner.db` (or configurable path)
- [ ] Script creates `data/` directory if it doesn't exist
- [ ] Script outputs success/failure messages
- [ ] Script is executable (`chmod +x`)
- [ ] Script has proper error handling
- [ ] README instructions reference this script

---

## Implementation Notes

**Create `scripts/init-db.sh` with the following content:**

```bash
#!/usr/bin/env bash
set -euo pipefail

# EthScanner Distributed - Database Initialization Script
# Applies schema.sql to create/reset the SQLite database

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Configuration
DB_DIR="${PROJECT_ROOT}/data"
DB_FILE="${DB_DIR}/ethscanner.db"
SCHEMA_FILE="${PROJECT_ROOT}/docs/database/schema.sql"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================="
echo "EthScanner Database Initialization"
echo "========================================="

# Check if schema file exists
if [ ! -f "$SCHEMA_FILE" ]; then
    echo -e "${RED}Error: Schema file not found at $SCHEMA_FILE${NC}"
    exit 1
fi

# Create data directory if it doesn't exist
if [ ! -d "$DB_DIR" ]; then
    echo -e "${YELLOW}Creating data directory: $DB_DIR${NC}"
    mkdir -p "$DB_DIR"
fi

# Check if database already exists
if [ -f "$DB_FILE" ]; then
    echo -e "${YELLOW}Warning: Database already exists at $DB_FILE${NC}"
    read -p "Do you want to recreate it? This will DELETE all data! (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Removing existing database...${NC}"
        rm "$DB_FILE"
    else
        echo -e "${YELLOW}Aborting. Existing database preserved.${NC}"
        exit 0
    fi
fi

# Check if sqlite3 is installed
if ! command -v sqlite3 &> /dev/null; then
    echo -e "${RED}Error: sqlite3 command not found. Please install SQLite.${NC}"
    echo "  Ubuntu/Debian: sudo apt-get install sqlite3"
    echo "  macOS: brew install sqlite3"
    echo "  Fedora: sudo dnf install sqlite"
    exit 1
fi

# Apply schema
echo -e "${GREEN}Applying schema to database...${NC}"
sqlite3 "$DB_FILE" < "$SCHEMA_FILE"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ Database initialized successfully!${NC}"
    echo "  Location: $DB_FILE"
    
    # Show created tables
    echo ""
    echo "Tables created:"
    sqlite3 "$DB_FILE" "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" | while read table; do
        echo "  - $table"
    done
    
    echo ""
    echo -e "${GREEN}Database is ready to use.${NC}"
else
    echo -e "${RED}✗ Failed to initialize database.${NC}"
    exit 1
fi
```

**Make the script executable:**
```bash
chmod +x scripts/init-db.sh
```

**Key Points:**
- Uses `set -euo pipefail` for strict error handling
- Checks for required dependencies (sqlite3)
- Creates `data/` directory if missing
- Prompts before overwriting existing database
- Provides colored output for better UX
- Lists created tables for verification

---

## Testing

**How to verify this task is complete:**

1. **Check script is executable:**
   ```bash
   ls -l scripts/init-db.sh
   # Should show -rwxr-xr-x (executable)
   ```

2. **Run the script:**
   ```bash
   ./scripts/init-db.sh
   ```

3. **Verify database was created:**
   ```bash
   ls -lh data/ethscanner.db
   sqlite3 data/ethscanner.db "SELECT name FROM sqlite_master WHERE type='table';"
   ```

4. **Expected output:**
   - Script runs without errors
   - Database file created at `data/ethscanner.db`
   - Tables listed: `jobs`, `results`, `workers`, `stats_summary` (view)

5. **Test idempotency (run script again):**
   ```bash
   ./scripts/init-db.sh
   # Should prompt to recreate database
   ```

---

## References

- **SDD:** `docs/architecture/system-design-document.md` (Database Schema section)
- **Schema:** `docs/database/schema.sql`
- **Related Tasks:** 
  - P02-T010: Validate schema against SDD
  - P02-T060: Implement database initialization in Go

---

## Notes

- The `data/` directory should be added to `.gitignore` (handled in P01-T030)
- This script is for development; production deployments may use different initialization methods
- Script uses SQLite CLI; the Go application will use `modernc.org/sqlite`
- Consider adding a `--force` flag to skip confirmation prompt in CI/CD pipelines
- Can extend script later to support seeding initial data (e.g., test prefixes)
