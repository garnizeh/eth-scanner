# P04-T100: Implement final_nonce validation (must equal nonce_end)

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T090  
**Estimated Effort:** Small (< 1h)

---

## Description

Add validation to the job completion endpoint to ensure the worker actually scanned the entire assigned nonce range. The final_nonce reported by the worker must exactly match the job's nonce_end value.

---

## Acceptance Criteria

- [ ] Completion handler validates `final_nonce == job.nonce_end`
- [ ] Returns 400 Bad Request if final_nonce doesn't match nonce_end
- [ ] Error message explains the mismatch clearly
- [ ] Unit test covers: final_nonce < nonce_end (partial completion)
- [ ] Unit test covers: final_nonce > nonce_end (error)
- [ ] Unit test covers: final_nonce == nonce_end (success)

---

## Implementation Notes

**Key Points:**
- This ensures data integrity — no partial completions allowed
- Workers must scan from nonce_start to nonce_end inclusive
- If worker couldn't complete range, it should NOT call complete endpoint

**Validation Logic:**
```go
job, err := db.GetJob(ctx, jobID)
if err != nil {
    return 404
}

if req.FinalNonce != job.NonceEnd {
    return 400, error(
        "final_nonce must equal nonce_end: expected %d, got %d",
        job.NonceEnd, req.FinalNonce,
    )
}

// Proceed with completion...
```

**Error Response:**
```json
{
  "error": "validation_failed",
  "details": "final_nonce (50000) does not match nonce_end (999999). Job not fully scanned."
}
```

---

## Testing

- Test final_nonce == nonce_end → 200 OK
- Test final_nonce < nonce_end → 400 Bad Request
- Test final_nonce > nonce_end → 400 Bad Request
- Verify error message contains expected vs actual values

---

## References

- Data integrity: Ensure complete range coverage
- Related: P04-T090 (complete endpoint)
- SDD: No partial job completion allowed in MVP
