# P05-T030: Implement LeaseBatch() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

## Description

Implement the `LeaseBatch()` function in the worker client to request a new job batch from the Master API. This function will send a POST request to `/api/v1/jobs/lease` with the worker's ID and requested batch size, and return the leased job details.

## Acceptance Criteria

- [ ] `LeaseBatch(ctx context.Context, requestedBatchSize uint32)` function added to `Client`
- [ ] Function sends POST request to `/api/v1/jobs/lease`
- [ ] Request includes API key in `X-API-Key` header
- [ ] Request body contains:
  - `worker_id` (string)
  - `requested_batch_size` (uint32)
- [ ] Response parsed into `JobLease` struct with fields:
  - `JobID` (string)
  - `Prefix28` ([]byte) - hex-decoded from response
  - `NonceStart` (uint32)
  - `NonceEnd` (uint32)
  - `ExpiresAt` (time.Time) - parsed as UTC
- [ ] Context cancellation is respected (timeout, manual cancel)
- [ ] Returns `ErrNoJobsAvailable` when API returns 404
- [ ] Returns descriptive error for other failure cases
- [ ] Hex decoding of `prefix_28` field validated (must be exactly 28 bytes)

## Implementation Notes

### Function Signature
```go
package worker

import (
    "context"
    "encoding/hex"
    "errors"
    "time"
)

var ErrNoJobsAvailable = errors.New("no jobs available")

type JobLease struct {
    JobID      string
    Prefix28   []byte
    NonceStart uint32
    NonceEnd   uint32
    ExpiresAt  time.Time
}

func (c *Client) LeaseBatch(ctx context.Context, requestedBatchSize uint32) (*JobLease, error) {
    // Build request
    req := leaseRequest{
        WorkerID:           c.workerID,
        RequestedBatchSize: requestedBatchSize,
    }
    
    // Make API call
    var resp leaseResponse
    err := c.doRequestWithContext(ctx, "POST", "/api/v1/jobs/lease", req, &resp)
    if err != nil {
        // Check for 404 (no jobs available)
        if apiErr, ok := err.(*APIError); ok && apiErr.StatusCode == 404 {
            return nil, ErrNoJobsAvailable
        }
        return nil, fmt.Errorf("lease request failed: %w", err)
    }
    
    // Decode prefix_28 from hex
    prefix28, err := hex.DecodeString(resp.Prefix28)
    if err != nil || len(prefix28) != 28 {
        return nil, fmt.Errorf("invalid prefix_28: %w", err)
    }
    
    // Parse expires_at as UTC
    expiresAt, err := time.Parse(time.RFC3339, resp.ExpiresAt)
    if err != nil {
        return nil, fmt.Errorf("invalid expires_at: %w", err)
    }
    
    return &JobLease{
        JobID:      resp.JobID,
        Prefix28:   prefix28,
        NonceStart: resp.NonceStart,
        NonceEnd:   resp.NonceEnd,
        ExpiresAt:  expiresAt.UTC(),
    }, nil
}

// Internal request/response types
type leaseRequest struct {
    WorkerID           string `json:"worker_id"`
    RequestedBatchSize uint32 `json:"requested_batch_size"`
}

type leaseResponse struct {
    JobID      string `json:"job_id"`
    Prefix28   string `json:"prefix_28"` // hex-encoded
    NonceStart uint32 `json:"nonce_start"`
    NonceEnd   uint32 `json:"nonce_end"`
    ExpiresAt  string `json:"expires_at"` // RFC3339
}
```

### API Request Example
```json
POST /api/v1/jobs/lease
X-API-Key: sk_test_1234567890abcdef
Content-Type: application/json

{
  "worker_id": "worker-pc-001",
  "requested_batch_size": 4294967296
}
```

### API Response Example (Success)
```json
{
  "job_id": "01234567-89ab-cdef-0123-456789abcdef",
  "prefix_28": "0000000000000000000000000000000000000000000000000000000000",
  "nonce_start": 0,
  "nonce_end": 4294967295,
  "expires_at": "2026-02-15T12:00:00Z"
}
```

### API Response Example (No Jobs)
```json
HTTP 404 Not Found
{
  "error": "no jobs available"
}
```

## Testing

```bash
cd /home/user/code/garnizeh/eth-scanner/go
go test ./internal/worker -v -run TestLeaseBatch
```

### Test Cases
- Successful lease request returns valid `JobLease`
- `prefix_28` is correctly hex-decoded to 28 bytes
- `expires_at` is parsed as UTC
- Context timeout cancels the request
- 404 response returns `ErrNoJobsAvailable`
- Invalid `prefix_28` (wrong length) returns error
- Invalid `expires_at` format returns error
- Missing API key returns 401 error
- Invalid API key returns 401 error

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1.1: Lease Job)
- Master API: P04-T050 (implements lease endpoint)
- API key auth: P04-T160
- Related tasks: P05-T020 (Client), P05-T080 (uses LeaseBatch in main loop)
