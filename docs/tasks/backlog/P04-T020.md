# P04-T020: Implement job lease logic - find available/expired job from DB

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T010, P02-T040  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the core lease logic that finds and assigns available or expired jobs to workers. This method will query the database for jobs in `pending` status or jobs that have expired (UTC timestamp check), update them to `processing` status, set the worker_id, and calculate a new expiration timestamp.

---

## Acceptance Criteria

- [ ] Method `LeaseExistingJob(ctx context.Context, workerID string) (*Job, error)` implemented in Manager
- [ ] Query finds jobs with status='pending' OR (status='processing' AND expires_at < NOW())
- [ ] Job is updated with new worker_id, status='processing', and expires_at (UTC)
- [ ] Uses UTC timestamps exclusively (`time.Now().UTC()`)
- [ ] Transaction handling ensures atomicity
- [ ] Returns nil if no jobs available (not an error)
- [ ] Unit tests cover pending job lease, expired job re-lease, and no jobs available

---

## Implementation Notes

**Key Points:**
- Reference SDD: Lease system with expiration handling
- Use `context.Context` for cancellation
- Lease duration should be configurable (default: 1 hour)
- Must use UTC: `time.Now().UTC().Add(leaseDuration)`
- Consider using database transactions or atomic updates

**SQL Query Pattern:**
```sql
-- Find leasable job
SELECT * FROM jobs 
WHERE status = 'pending' 
   OR (status = 'processing' AND expires_at < ?)
ORDER BY id ASC
LIMIT 1;

-- Update to lease it
UPDATE jobs 
SET status = 'processing', 
    worker_id = ?, 
    expires_at = ?
WHERE id = ?;
```

---

## Testing

- Test leasing a pending job
- Test re-leasing an expired job
- Test when no jobs are available (should return nil, nil)
- Verify UTC timestamps are used
- Test concurrent lease attempts (race conditions)

---

## References

- SDD: Section on Distributed Scanning Logic and Lease System
- Database: `internal/database/queries.sql.go`
- Time handling: `copilot-instructions.md` â€” always UTC
