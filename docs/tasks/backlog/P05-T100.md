# P05-T100: Create cmd/worker-pc/main.go entry point

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P05-T080  
**Estimated Effort:** Small

---

## Description

Create the main entry point for the PC worker executable. This file will initialize the worker configuration, set up logging, handle signals for graceful shutdown, and start the worker main loop.

## Acceptance Criteria

- [ ] File `go/cmd/worker-pc/main.go` exists
- [ ] `main()` function initializes:
  - Logging (stdout, structured or simple)
  - Configuration loading (from env vars)
  - Worker instance
  - Signal handling (SIGINT, SIGTERM for graceful shutdown)
- [ ] Context is created with signal-based cancellation
- [ ] Worker runs until context is cancelled or fatal error
- [ ] Exit code is 0 on graceful shutdown, non-zero on error
- [ ] Logs startup message with worker ID and API URL
- [ ] Logs shutdown message on exit

## Implementation Notes

### Main Entry Point
```go
package main

import (
    "context"
    "log"
    "os"
    "os/signal"
    "syscall"
    
    "github.com/your-org/eth-scanner/internal/worker"
)

func main() {
    // Setup logging
    log.SetFlags(log.LstdFlags | log.Lshortfile)
    log.Println("EthScanner PC Worker starting...")
    
    // Load configuration
    config, err := worker.LoadConfig()
    if err != nil {
        log.Fatalf("Failed to load config: %v", err)
    }
    
    log.Printf("Configuration loaded:")
    log.Printf("  API URL: %s", config.APIURL)
    log.Printf("  Worker ID: %s", config.WorkerID)
    log.Printf("  Checkpoint Interval: %v", config.CheckpointInterval)
    
    // Create worker
    w := worker.NewWorker(config)
    
    // Setup signal handling for graceful shutdown
    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()
    
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)
    
    go func() {
        sig := <-sigChan
        log.Printf("Received signal %v, initiating graceful shutdown...", sig)
        cancel()
    }()
    
    // Run worker
    log.Println("Worker started, waiting for jobs...")
    err = w.Run(ctx)
    if err != nil && err != context.Canceled {
        log.Fatalf("Worker failed: %v", err)
    }
    
    log.Println("Worker stopped gracefully")
}
```

### Signal Handling
The worker should handle:
- `SIGINT` (Ctrl+C): Graceful shutdown
- `SIGTERM` (kill): Graceful shutdown

Both signals should:
1. Cancel the context
2. Allow current batch to finish or send final checkpoint
3. Exit cleanly

### Environment Variables
Remind user to set required environment variables before running:
```bash
export WORKER_API_URL="http://localhost:8080"
export WORKER_ID="worker-pc-001"
export WORKER_API_KEY="sk_test_1234567890abcdef"
export WORKER_CHECKPOINT_INTERVAL="5m"  # optional
```

### Logging Best Practices
For production, consider using structured logging:
```go
import "log/slog"

logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))
logger.Info("Worker starting", 
    "worker_id", config.WorkerID, 
    "api_url", config.APIURL)
```

For MVP, simple `log` package is sufficient.

### Exit Codes
- `0`: Graceful shutdown (context cancelled)
- `1`: Configuration error
- `2`: Fatal runtime error

### Build and Run
```bash
# Build
cd /home/user/code/garnizeh/eth-scanner/go
go build -o bin/worker-pc ./cmd/worker-pc

# Run
./bin/worker-pc
```

Or use Makefile:
```makefile
.PHONY: worker-pc
worker-pc:
	go build -o bin/worker-pc ./cmd/worker-pc

.PHONY: run-worker-pc
run-worker-pc: worker-pc
	./bin/worker-pc
```

## Testing

### Manual Testing
```bash
cd /home/user/code/garnizeh/eth-scanner/go

# Set environment
export WORKER_API_URL="http://localhost:8080"
export WORKER_ID="test-worker-001"
export WORKER_API_KEY="sk_test_abc123"

# Build
make worker-pc

# Run (Ctrl+C to stop)
./bin/worker-pc
```

Expected output:
```
2026/02/15 10:00:00 EthScanner PC Worker starting...
2026/02/15 10:00:00 Configuration loaded:
2026/02/15 10:00:00   API URL: http://localhost:8080
2026/02/15 10:00:00   Worker ID: test-worker-001
2026/02/15 10:00:00   Checkpoint Interval: 5m0s
2026/02/15 10:00:00 Worker started, waiting for jobs...
2026/02/15 10:00:01 Requesting batch size: 2880000000 keys (~1 hour)
2026/02/15 10:00:01 No jobs available, waiting 1s...
^C
2026/02/15 10:00:05 Received signal interrupt, initiating graceful shutdown...
2026/02/15 10:00:05 Worker shutting down gracefully...
2026/02/15 10:00:05 Worker stopped gracefully
```

### Integration Test
Run with Master API:
1. Start Master API: `cd go && make run-master`
2. Populate database with jobs (using script from P10-T090)
3. Start PC worker: `make run-worker-pc`
4. Verify worker leases jobs, sends checkpoints, completes jobs

### Error Handling Test
1. **Missing config:** Unset `WORKER_API_URL` → expect fatal error
2. **Invalid API URL:** Set to invalid URL → expect connection error
3. **API unreachable:** Stop Master API → expect retry with backoff
4. **Graceful shutdown:** Send SIGINT during batch → expect checkpoint and clean exit

## References

- SDD: `docs/architecture/system-design-document.md` (Section 5: PC Worker Architecture)
- Related tasks:
  - P05-T010 (Config)
  - P05-T080 (main loop)
  - P01-T070 (Makefile)
- Go stdlib: `context`, `os/signal`, `log`
