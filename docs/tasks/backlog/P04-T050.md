# P04-T050: Create POST /api/v1/jobs/lease handler

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T040  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the HTTP handler for the `/api/v1/jobs/lease` endpoint. This endpoint allows workers to request a job assignment. The handler will attempt to lease an existing job, or create a new batch if none are available.

---

## Acceptance Criteria

- [ ] Handler `handleJobLease` implemented in `internal/server/` (or dedicated jobs handler file)
- [ ] Accepts POST request with JSON body: `{"worker_id": "...", "requested_batch_size": 1000000}`
- [ ] Validates request: worker_id non-empty, batch_size > 0 and <= max allowed
- [ ] Tries to lease existing job via `LeaseExistingJob()`
- [ ] If no job available, creates new batch via `CreateBatch()`
- [ ] Returns 200 OK with job JSON on success
- [ ] Returns 400 Bad Request for validation errors
- [ ] Returns 500 Internal Server Error for database errors
- [ ] Route registered in `routes.go`
- [ ] Integration test verifies full lease flow

---

## Implementation Notes

**Key Points:**
- Reference SDD: API Endpoint â€” POST /api/v1/jobs/lease
- Request body must specify worker_id and requested_batch_size
- Response includes all job fields needed by worker (prefix_28, nonce_start, nonce_end, expires_at, etc.)

**Request Schema:**
```json
{
  "worker_id": "worker-pc-001",
  "requested_batch_size": 1000000,
  "prefix_28": "base64-encoded-28-bytes" // optional: request specific prefix
}
```

**Response Schema:**
```json
{
  "job_id": 123,
  "prefix_28": "base64-encoded",
  "nonce_start": 0,
  "nonce_end": 999999,
  "current_nonce": 0,
  "expires_at": "2026-02-15T14:30:00Z"
}
```

**Handler Logic:**
```go
1. Parse and validate request body
2. Try LeaseExistingJob(worker_id)
3. If nil (no jobs available):
   - Call CreateBatch(prefix_28, requested_batch_size)
   - Then lease the newly created job
4. Return job as JSON
```

---

## Testing

- Test leasing existing pending job
- Test leasing expired job
- Test creating new batch when none available
- Test validation errors (missing worker_id, invalid batch_size)
- Test concurrent lease requests

---

## References

- SDD: Section 5.1 â€” API Endpoints
- Route registration: `internal/server/routes.go`
- Manager methods: P04-T020, P04-T040
