# P05-T020: Implement internal/worker/client.go

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P05-T010  
**Estimated Effort:** Medium

---

## Description

Implement HTTP client for communicating with the Master API. This client will handle all HTTP requests including authentication via API key header, JSON marshaling/unmarshaling, error handling, and timeouts.

## Acceptance Criteria

- [ ] File `go/internal/worker/client.go` exists
- [ ] `Client` struct defined with fields:
  - `httpClient` (*http.Client)
  - `baseURL` (string)
  - `workerID` (string)
  - `apiKey` (string)
- [ ] `NewClient(config *Config)` constructor function
- [ ] HTTP client configured with reasonable timeouts (30s default)
- [ ] All requests include `X-API-Key` header with the API key
- [ ] All requests include `Content-Type: application/json` header
- [ ] Helper methods for common HTTP operations:
  - `doRequest(method, path string, body, response interface{}) error`
- [ ] Proper error handling for network errors, non-2xx status codes
- [ ] Error responses from API are parsed and returned as Go errors
- [ ] Follow UTC time handling (parse API timestamps as UTC)

## Implementation Notes

### Client Structure
```go
package worker

import (
    "net/http"
    "time"
)

type Client struct {
    httpClient *http.Client
    baseURL    string
    workerID   string
    apiKey     string
}

func NewClient(config *Config) *Client {
    return &Client{
        httpClient: &http.Client{
            Timeout: 30 * time.Second,
        },
        baseURL:  config.APIURL,
        workerID: config.WorkerID,
        apiKey:   config.APIKey,
    }
}

func (c *Client) doRequest(method, path string, reqBody, respBody interface{}) error {
    // Build full URL
    // Marshal request body to JSON (if not nil)
    // Create HTTP request
    // Add headers: X-API-Key, Content-Type
    // Execute request
    // Check status code
    // Unmarshal response body
    // Return error or nil
}
```

### API Key Authentication
All requests to the Master API must include the API key in the header:
```
X-API-Key: sk_test_1234567890abcdef
```

The Master API will validate this key before processing the request (see P04-T160).

### Error Handling
```go
type APIError struct {
    StatusCode int
    Message    string
}

func (e *APIError) Error() string {
    return fmt.Sprintf("API error %d: %s", e.StatusCode, e.Message)
}
```

Parse error responses from Master API:
```json
{
  "error": "invalid worker_id",
  "message": "worker_id cannot be empty"
}
```

### Request/Response Types
Define basic types for API communication (detailed types will be added in P05-T030-T060):
```go
type LeaseRequest struct {
    WorkerID           string `json:"worker_id"`
    RequestedBatchSize uint32 `json:"requested_batch_size"`
}

type LeaseResponse struct {
    JobID      string `json:"job_id"`
    Prefix28   string `json:"prefix_28"`
    NonceStart uint32 `json:"nonce_start"`
    NonceEnd   uint32 `json:"nonce_end"`
    ExpiresAt  string `json:"expires_at"` // RFC3339 UTC
}
```

## Testing

```bash
cd /home/user/code/garnizeh/eth-scanner/go
go test ./internal/worker -v -run TestClient
```

### Test Cases
- Client creation with valid config
- `doRequest` adds correct headers (X-API-Key, Content-Type)
- `doRequest` marshals request body correctly
- `doRequest` unmarshals response body correctly
- `doRequest` handles HTTP errors (4xx, 5xx)
- `doRequest` handles network timeouts
- API error responses are parsed correctly

### Mock Server for Testing
Use `httptest.NewServer` to mock Master API responses:
```go
server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    // Verify X-API-Key header
    if r.Header.Get("X-API-Key") != "test-key" {
        w.WriteHeader(http.StatusUnauthorized)
        return
    }
    // Return mock response
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(mockResponse)
}))
defer server.Close()
```

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1: API Endpoints)
- Related tasks: P05-T010 (provides Config), P05-T030-T060 (use this client)
- Go stdlib: `net/http`, `encoding/json`, `context`
- API key middleware: P04-T160
