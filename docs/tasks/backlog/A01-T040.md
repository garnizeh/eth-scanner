# A01-T040: Refactor jobs table schema for long-lived job model

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** None  
**Estimated Effort:** Medium (1-3h)

---

## Description

Refactor the database schema and job management logic to support long-lived "Macro Jobs" that represent large nonce ranges. Instead of creating a new job row for every small batch request, workers will lease and update a single job record as they progress through the range via checkpoints.

This addresses database bloat caused by storing every individual batch as a permanent completed job record.

---

## Acceptance Criteria

- [ ] Review current `jobs` table schema in `internal/database/sql/001_schema.sql`
- [ ] Verify schema supports long-lived job pattern (current_nonce, expires_at, status transitions)
- [ ] Update schema comments documenting the "Macro Job" concept and long-lived job lifecycle
- [ ] Ensure indexes are optimized for UPDATE-heavy workload (fewer INSERTs of new jobs)
- [ ] Update `internal/jobs/manager.go` to support "find or create macro job" logic
- [ ] Write unit tests verifying same job record is reused across multiple checkpoint updates
- [ ] Document the new job lifecycle in code comments
- [ ] Delete existing `data/eth-scanner.db` if present (fresh start with new approach)

---

## Implementation Notes

**Key Concept:**
- Current: Worker requests work → Master creates new job → Worker completes → Job marked completed (persists forever)
- New: Worker requests work → Master finds/creates macro job for prefix → Worker leases → Multiple checkpoints update current_nonce → Job marked completed only when entire range is done

**Schema Validation:**
- Ensure `current_nonce` can track progress within the job
- Ensure `nonce_start` and `nonce_end` define the full range
- Verify `status` transitions: pending → processing (with checkpoints) → completed
- Confirm `expires_at` supports lease expiration and reassignment

**Job Manager Changes:**
- Modify `LeaseExistingJob` or create new method `FindOrCreateMacroJob`
- When worker requests work for a prefix:
  1. Check if an incomplete macro job exists for that prefix
  2. If yes, lease it (update worker_id, expires_at) and return current_nonce as start point
  3. If no, create new macro job covering large range (e.g., 0 to 2^32-1)
- Checkpoints update `current_nonce` without creating new rows

**Reference:**
- See `docs/architecture/db-optimization-proposal.md` section 2.A

---

## Testing Strategy

- Unit test: Create job, lease it, checkpoint 3 times, verify same job ID with updated current_nonce
- Unit test: Simulate lease expiration, verify another worker can pick up from last checkpoint
- Integration test: Multiple workers processing different prefixes concurrently
- Verify no "completed" jobs are created until entire nonce range is exhausted

---

## Progress Log

### [Date] - [Status Update]
- [Notes on implementation progress]
