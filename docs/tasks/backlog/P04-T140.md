# P04-T140: Write integration tests for checkpoint endpoint

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** Medium  
**Dependencies:** P04-T070  
**Estimated Effort:** Medium (1-3h)

---

## Description

Create integration tests for the checkpoint endpoint that verify progress updates work correctly, worker_id validation is enforced, and concurrent checkpoints are handled safely.

---

## Acceptance Criteria

- [ ] Test file `internal/server/jobs_checkpoint_test.go` created
- [ ] Test: Successful checkpoint update (current_nonce and keys_scanned updated)
- [ ] Test: Worker_id mismatch returns 403 Forbidden
- [ ] Test: Checkpointing non-existent job returns 404
- [ ] Test: Checkpointing completed job returns 400 Bad Request
- [ ] Test: Concurrent checkpoints from same worker (last write wins or merge)
- [ ] Test: Checkpoint updates updated_at timestamp (UTC)
- [ ] Test: current_nonce cannot exceed nonce_end (validation)
- [ ] All tests use `t.TempDir()` for temporary database

---

## Implementation Notes

**Key Points:**
- Test both successful and error scenarios
- Verify database state after checkpoint (query job to confirm update)
- Test edge cases: current_nonce = nonce_end (valid), current_nonce > nonce_end (invalid)

**Test Structure:**
```go
func TestJobCheckpoint_Success(t *testing.T) {
    db := setupTestDB(t)
    defer db.Close()
    
    // Insert processing job
    job := insertTestJob(db, "processing", "worker-1", futureTime)
    
    // Send checkpoint
    resp := testCheckpoint(t, job.ID, "worker-1", 50000, 50000)
    
    // Assertions
    assert.Equal(t, 200, resp.StatusCode)
    
    // Verify database updated
    updated := getJob(db, job.ID)
    assert.Equal(t, uint32(50000), updated.CurrentNonce)
    assert.Equal(t, uint64(50000), updated.KeysScanned)
}

func TestJobCheckpoint_WorkerMismatch(t *testing.T) {
    // worker-2 tries to checkpoint worker-1's job
    resp := testCheckpoint(t, job.ID, "worker-2", 50000, 50000)
    assert.Equal(t, 403, resp.StatusCode)
}
```

---

## Testing

- Run `go test -v ./internal/server -run TestJobCheckpoint`
- Test with concurrent checkpoint requests (race conditions)
- Verify updated_at timestamp changes on each checkpoint

---

## References

- Related: P04-T070 (checkpoint handler), P04-T080 (worker_id validation)
- Testing pattern: Follow P04-T130 (lease tests)
