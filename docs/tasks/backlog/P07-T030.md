# P07-T030: Implement ESP-NETIF WiFi handler with Event Loop

**Phase:** P07 - ESP32 Worker - Core Infrastructure  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P07-T020  
**Estimated Effort:** Medium

---

## Description

Implement WiFi connection handler using ESP-NETIF with Event Loop for automatic reconnection and exponential backoff. This ensures robust network connectivity for API communication.

## Acceptance Criteria

- [x] ESP-NETIF initialized in station mode
- [x] Event loop configured for WiFi and IP events
- [x] WiFi connection established using Kconfig credentials
- [x] Auto-reconnect implemented with exponential backoff
- [x] Connection status logged via ESP_LOG
- [x] Blocks until WiFi connected before proceeding

## Implementation Notes

**File:** `esp32/src/wifi_handler.c` (and corresponding `.h`)

**Key ESP-IDF APIs:**
- `esp_netif_init()`
- `esp_event_loop_create_default()`
- `esp_netif_create_default_wifi_sta()`
- `esp_wifi_init()`, `esp_wifi_set_mode()`, `esp_wifi_set_config()`
- `esp_wifi_start()`, `esp_wifi_connect()`

**Event handlers:**
- `WIFI_EVENT_STA_DISCONNECTED` → trigger reconnect with backoff
- `IP_EVENT_STA_GOT_IP` → log IP address, set connected flag

**Backoff logic:**
```c
static int retry_count = 0;
static const int max_retries = 10;
static const int backoff_delays[] = {1, 2, 5, 10, 30}; // seconds

void wifi_event_handler(void* arg, esp_event_base_t event_base,
                       int32_t event_id, void* event_data)
{
    if (event_id == WIFI_EVENT_STA_DISCONNECTED) {
        if (retry_count < max_retries) {
            int delay = backoff_delays[MIN(retry_count, 4)];
            ESP_LOGW(TAG, "Disconnected, retrying in %d sec...", delay);
            vTaskDelay(pdMS_TO_TICKS(delay * 1000));
            esp_wifi_connect();
            retry_count++;
        } else {
            ESP_LOGE(TAG, "Max retries reached, restarting...");
            esp_restart();
        }
    } else if (event_id == IP_EVENT_STA_GOT_IP) {
        ip_event_got_ip_t* event = (ip_event_got_ip_t*) event_data;
        ESP_LOGI(TAG, "Got IP: " IPSTR, IP2STR(&event->ip_info.ip));
        retry_count = 0; // Reset on successful connection
    }
}
```

**Integration in `app_main()`:**
```c
void app_main(void)
{
    ESP_ERROR_CHECK(nvs_flash_init());
    ESP_ERROR_CHECK(esp_netif_init());
    ESP_ERROR_CHECK(esp_event_loop_create_default());
    
    wifi_init_sta();  // Blocks until connected
    
    ESP_LOGI(TAG, "WiFi connected, starting worker tasks...");
    // Continue with HTTP client initialization
}
```

## Testing

- Flash firmware to ESP32
- Verify WiFi connection successful via serial log
- Disconnect WiFi AP and verify auto-reconnect with backoff
- Force multiple reconnect failures and verify ESP32 restarts after max retries
- Check IP address logged correctly

## References

- SDD: `docs/architecture/system-design-document.md` (ESP32 Networking)
- ESP-IDF WiFi Guide: https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html
- Related tasks: P07-T040 (HTTP client will use this connection)
