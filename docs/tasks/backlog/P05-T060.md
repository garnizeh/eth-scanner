# P05-T060: Implement SubmitResult() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** Medium  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

## Description

Implement the `SubmitResult()` function in the worker client to submit a found private key match to the Master API. This is called when the worker successfully finds a private key that matches the target Ethereum address.

## Acceptance Criteria

- [ ] `SubmitResult(ctx context.Context, privateKey []byte, address string)` function added to `Client`
- [ ] Function sends POST request to `/api/v1/results`
- [ ] Request includes API key in `X-API-Key` header
- [ ] Request body contains:
  - `worker_id` (string)
  - `private_key` (string) - hex-encoded 32-byte private key
  - `ethereum_address` (string) - checksummed Ethereum address
  - `found_at` (string) - RFC3339 UTC timestamp
- [ ] Response status 201 Created indicates success
- [ ] Context cancellation is respected
- [ ] Private key validation (must be exactly 32 bytes)
- [ ] Ethereum address validation (must be valid format)
- [ ] Returns descriptive error for failure cases

## Implementation Notes

### Function Signature
```go
package worker

import (
    "context"
    "encoding/hex"
    "time"
)

func (c *Client) SubmitResult(ctx context.Context, privateKey []byte, address string) error {
    // Validate inputs
    if len(privateKey) != 32 {
        return fmt.Errorf("invalid private key length: expected 32 bytes, got %d", len(privateKey))
    }
    
    // Build request
    req := resultRequest{
        WorkerID:        c.workerID,
        PrivateKey:      hex.EncodeToString(privateKey),
        EthereumAddress: address,
        FoundAt:         time.Now().UTC().Format(time.RFC3339),
    }
    
    // Make API call
    err := c.doRequestWithContext(ctx, "POST", "/api/v1/results", req, nil)
    if err != nil {
        return fmt.Errorf("result submission failed: %w", err)
    }
    
    return nil
}

// Internal request type
type resultRequest struct {
    WorkerID        string `json:"worker_id"`
    PrivateKey      string `json:"private_key"`      // hex-encoded
    EthereumAddress string `json:"ethereum_address"` // checksummed
    FoundAt         string `json:"found_at"`         // RFC3339 UTC
}
```

### API Request Example
```json
POST /api/v1/results
X-API-Key: sk_test_1234567890abcdef
Content-Type: application/json

{
  "worker_id": "worker-pc-001",
  "private_key": "0000000000000000000000000000000000000000000000000000000012345678",
  "ethereum_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "found_at": "2026-02-15T10:30:00Z"
}
```

### API Response Example (Success)
```
HTTP 201 Created
```

### API Response Example (Errors)
```json
HTTP 400 Bad Request
{
  "error": "invalid private_key",
  "message": "private_key must be 64 hex characters (32 bytes)"
}
```

```json
HTTP 400 Bad Request
{
  "error": "invalid ethereum_address",
  "message": "ethereum_address must be a valid checksummed address"
}
```

### Timestamp Handling
Always use UTC for `found_at`:
```go
foundAt := time.Now().UTC().Format(time.RFC3339)
```

## Testing

```bash
cd /home/user/code/garnizeh/eth-scanner/go
go test ./internal/worker -v -run TestSubmitResult
```

### Test Cases
- Successful result submission (201 Created)
- Private key is correctly hex-encoded
- Ethereum address is included
- `found_at` timestamp is in RFC3339 UTC format
- X-API-Key header is included
- Context timeout cancels the request
- Invalid private key length (not 32 bytes) returns error
- 400 error (invalid private_key format) returns error
- 400 error (invalid ethereum_address) returns error
- 401 error (missing/invalid API key) returns error

### Mock Server Test
```go
func TestSubmitResult(t *testing.T) {
    server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Verify method
        if r.Method != "POST" {
            t.Errorf("expected POST, got %s", r.Method)
        }
        
        // Verify path
        if r.URL.Path != "/api/v1/results" {
            t.Errorf("expected /api/v1/results, got %s", r.URL.Path)
        }
        
        // Verify API key
        if r.Header.Get("X-API-Key") != "test-key" {
            w.WriteHeader(http.StatusUnauthorized)
            return
        }
        
        // Verify body
        var req resultRequest
        json.NewDecoder(r.Body).Decode(&req)
        if req.WorkerID != "test-worker" {
            t.Errorf("expected worker_id test-worker, got %s", req.WorkerID)
        }
        if len(req.PrivateKey) != 64 {
            t.Errorf("expected private_key length 64, got %d", len(req.PrivateKey))
        }
        
        // Verify timestamp is valid RFC3339
        _, err := time.Parse(time.RFC3339, req.FoundAt)
        if err != nil {
            t.Errorf("invalid found_at timestamp: %v", err)
        }
        
        w.WriteHeader(http.StatusCreated)
    }))
    defer server.Close()
    
    client := NewClient(&Config{
        APIURL:   server.URL,
        WorkerID: "test-worker",
        APIKey:   "test-key",
    })
    
    privateKey := make([]byte, 32)
    err := client.SubmitResult(context.Background(), privateKey, "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb")
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
}
```

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1.4: Submit Result)
- Master API: P04-T110 (implements results endpoint)
- API key auth: P04-T160
- Related tasks: P05-T020 (Client), P06-T040 (scanner calls this on match)
