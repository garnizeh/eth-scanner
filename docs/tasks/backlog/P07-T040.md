# P07-T040: Implement esp_http_client wrapper for Master API communication

**Phase:** P07 - ESP32 Worker - Core Infrastructure  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P07-T030  
**Estimated Effort:** Medium

---

## Description

Create wrapper functions around `esp_http_client` for making POST and PATCH requests to the Master API. This provides a clean interface for lease, checkpoint, and complete operations.

## Acceptance Criteria

- [x] HTTP client initialization function created
- [x] `api_lease_job()` function implemented (POST /api/v1/jobs/lease)
- [x] `api_checkpoint()` function implemented (PATCH /api/v1/jobs/{id}/checkpoint)
- [x] `api_complete()` function implemented (POST /api/v1/jobs/{id}/complete)
- [x] JSON request body construction using cJSON library
- [x] Response parsing and error handling
- [x] All functions return proper error codes

## Implementation Notes

**File:** `esp32/src/api_client.c` (and corresponding `.h`)

**Dependencies:**
- `esp_http_client.h`
- `cJSON.h` (for JSON serialization)

**Function signatures:**
```c
esp_err_t api_lease_job(const char* worker_id, uint32_t batch_size, 
                        job_info_t* out_job);

esp_err_t api_checkpoint(int64_t job_id, const char* worker_id,
                         uint64_t current_nonce, uint64_t keys_scanned,
                         uint64_t duration_ms);

esp_err_t api_complete(int64_t job_id, const char* worker_id,
                       uint64_t final_nonce, uint64_t keys_scanned,
                       uint64_t duration_ms);
```

**Example implementation for `api_lease_job()`:**
```c
esp_err_t api_lease_job(const char* worker_id, uint32_t batch_size, 
                        job_info_t* out_job)
{
    esp_http_client_config_t config = {
        .url = CONFIG_ETHSCANNER_API_URL "/api/v1/jobs/lease",
        .method = HTTP_METHOD_POST,
    };
    
    esp_http_client_handle_t client = esp_http_client_init(&config);
    
    // Build JSON request body
    cJSON* root = cJSON_CreateObject();
    cJSON_AddStringToObject(root, "worker_id", worker_id);
    cJSON_AddStringToObject(root, "worker_type", "esp32");
    cJSON_AddNumberToObject(root, "requested_batch_size", batch_size);
    
    char* json_str = cJSON_PrintUnformatted(root);
    
    esp_http_client_set_header(client, "Content-Type", "application/json");
    esp_http_client_set_post_field(client, json_str, strlen(json_str));
    
    esp_err_t err = esp_http_client_perform(client);
    
    if (err == ESP_OK) {
        int status = esp_http_client_get_status_code(client);
        if (status == 200) {
            // Parse response and populate out_job
            // ...
        }
    }
    
    cJSON_Delete(root);
    free(json_str);
    esp_http_client_cleanup(client);
    
    return err;
}
```

**Response parsing:**
- Use `esp_http_client_read()` to get response body
- Parse JSON with cJSON
- Extract `job_id`, `prefix_28`, `nonce_start`, `nonce_end`, `target_address`
- Decode base64 `prefix_28` (use mbedtls or custom decoder)

**Error handling:**
- HTTP 4xx/5xx → return ESP_FAIL with logged error
- Network timeout → return ESP_ERR_TIMEOUT
- JSON parse error → return ESP_ERR_INVALID_RESPONSE

## Testing

- Mock Master API server using Postman/curl
- Test `api_lease_job()` and verify JSON request format
- Test `api_checkpoint()` with valid job_id
- Test `api_complete()` and verify response
- Test error cases: network failure, HTTP 500, malformed JSON
- Verify memory cleanup (no leaks with cJSON)

## References

- SDD: `docs/architecture/system-design-document.md` (API Endpoints)
- ESP HTTP Client: https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_http_client.html
- cJSON Library: https://github.com/DaveGamble/cJSON
- Related tasks: P07-T050 (NVS will persist job info)
