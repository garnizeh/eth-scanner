# P04-T150: Write integration tests for complete endpoint

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** Medium  
**Dependencies:** P04-T090  
**Estimated Effort:** Medium (1-3h)

---

## Description

Create integration tests for the job completion endpoint that verify jobs can only be completed by their assigned worker, final_nonce validation works correctly, and job status transitions to completed.

---

## Acceptance Criteria

- [ ] Test file `internal/server/jobs_complete_test.go` created
- [ ] Test: Successful completion (status â†’ completed, completed_at set)
- [ ] Test: Worker_id mismatch returns 403 Forbidden
- [ ] Test: final_nonce != nonce_end returns 400 Bad Request
- [ ] Test: Completing non-existent job returns 404
- [ ] Test: Completing already completed job returns 400
- [ ] Test: Completing pending job (not assigned) returns 400
- [ ] Test: completed_at timestamp is UTC
- [ ] All tests use `t.TempDir()` for temporary database

---

## Implementation Notes

**Key Points:**
- Test validation logic thoroughly (final_nonce validation from P04-T100)
- Verify job status transitions correctly
- Check that completed_at is set to current UTC time

**Test Structure:**
```go
func TestJobComplete_Success(t *testing.T) {
    db := setupTestDB(t)
    defer db.Close()
    
    // Insert processing job (nonce_start=0, nonce_end=999999)
    job := insertTestJob(db, "processing", "worker-1", futureTime)
    
    // Complete job
    resp := testComplete(t, job.ID, "worker-1", 999999, 1000000)
    
    // Assertions
    assert.Equal(t, 200, resp.StatusCode)
    
    // Verify database
    completed := getJob(db, job.ID)
    assert.Equal(t, "completed", completed.Status)
    assert.Equal(t, uint32(999999), completed.CurrentNonce)
    assert.NotNil(t, completed.CompletedAt)
    assert.Equal(t, time.UTC, completed.CompletedAt.Location())
}

func TestJobComplete_FinalNonceMismatch(t *testing.T) {
    // Try to complete with final_nonce < nonce_end
    resp := testComplete(t, job.ID, "worker-1", 500000, 500000)
    assert.Equal(t, 400, resp.StatusCode)
    assert.Contains(t, resp.Error, "final_nonce must equal nonce_end")
}
```

---

## Testing

- Run `go test -v ./internal/server -run TestJobComplete`
- Verify all validation scenarios are covered
- Test idempotency (completing already completed job)

---

## References

- Related: P04-T090 (complete handler), P04-T100 (final_nonce validation)
- Testing pattern: Follow P04-T130, P04-T140
