# P04-T030: Implement nonce range allocation - get next available range for prefix

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T020  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the logic to determine the next available nonce range for a given 28-byte prefix. This function will query the database to find the highest nonce_end already allocated for the prefix and return the next sequential range based on the requested batch size.

---

## Acceptance Criteria

- [ ] Method `GetNextNonceRange(ctx context.Context, prefix28 []byte, batchSize uint32) (nonceStart, nonceEnd uint32, err error)` implemented
- [ ] Query finds MAX(nonce_end) for the given prefix_28
- [ ] If no jobs exist for prefix, start from nonce 0
- [ ] Calculate nonceStart = MAX(nonce_end) + 1, nonceEnd = nonceStart + batchSize - 1
- [ ] Handle uint32 overflow (return error if range exceeds max uint32)
- [ ] Validate prefix_28 is exactly 28 bytes
- [ ] Unit tests cover: first range, subsequent ranges, overflow detection

---

## Implementation Notes

**Key Points:**
- Reference SDD: Private key = 28-byte prefix + 4-byte nonce (little-endian)
- Nonce is uint32: range 0 to 4,294,967,295
- Batch size determines the nonce range size
- Must handle case where prefix has never been scanned before

**SQL Query Pattern:**
```sql
SELECT MAX(nonce_end) FROM jobs WHERE prefix_28 = ?;
```

**Algorithm:**
```go
maxNonce := queryResult // or 0 if NULL
nonceStart := maxNonce + 1
if nonceStart == 0 && maxNonce != 0 {
    return error("nonce range exhausted for this prefix")
}
nonceEnd := nonceStart + batchSize - 1
if nonceEnd < nonceStart { // overflow
    return error("batch size causes overflow")
}
```

---

## Testing

- Test first allocation for new prefix (should start at 0)
- Test subsequent allocation (should continue from previous end + 1)
- Test overflow detection (nonceStart near max uint32)
- Test invalid prefix length (should return error)

---

## References

- SDD: Section 4 â€” Distributed Scanning Logic (Space Partitioning)
- Database schema: `docs/database/schema.sql`
- Related: P04-T040 (batch creation uses this function)
