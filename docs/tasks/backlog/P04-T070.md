# P04-T070: Create PATCH /api/v1/jobs/{id}/checkpoint handler

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T010, P02-T040  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the checkpoint endpoint that allows workers to report progress on their assigned job. This enables the system to track how far through a nonce range a worker has scanned and to resume from this point if the worker fails or the lease expires.

---

## Acceptance Criteria

- [ ] Handler `handleJobCheckpoint` implemented
- [ ] Accepts PATCH request to `/api/v1/jobs/{id}/checkpoint`
- [ ] Request body: `{"worker_id": "...", "current_nonce": 12345, "keys_scanned": 12345}`
- [ ] Validates job exists and is in `processing` status
- [ ] Validates worker_id matches the job's assigned worker
- [ ] Updates job: current_nonce, keys_scanned, updated_at (UTC)
- [ ] Returns 200 OK with updated job on success
- [ ] Returns 403 Forbidden if worker_id mismatch
- [ ] Returns 404 Not Found if job doesn't exist
- [ ] Route registered in `routes.go`

---

## Implementation Notes

**Key Points:**
- Reference SDD: Checkpoint mechanism to minimize rework after failures
- Workers should send checkpoints periodically (e.g., every 5 minutes)
- current_nonce represents the last completely scanned nonce
- keys_scanned is cumulative count for this job

**Request Schema:**
```json
{
  "worker_id": "worker-pc-001",
  "current_nonce": 50000,
  "keys_scanned": 50000
}
```

**Response Schema:**
```json
{
  "job_id": 123,
  "current_nonce": 50000,
  "keys_scanned": 50000,
  "updated_at": "2026-02-15T14:35:00Z"
}
```

**SQL Update:**
```sql
UPDATE jobs 
SET current_nonce = ?, 
    keys_scanned = ?, 
    updated_at = ?
WHERE id = ? AND worker_id = ? AND status = 'processing';
```

---

## Testing

- Test successful checkpoint update
- Test worker_id mismatch (should return 403)
- Test job not found (should return 404)
- Test checkpointing completed job (should fail)
- Test concurrent checkpoint updates

---

## References

- SDD: Section 5.1 â€” API Endpoints (PATCH /api/v1/jobs/{job_id}/checkpoint)
- Database: `internal/database/queries.sql`
- Related: P04-T080 (worker_id validation)
