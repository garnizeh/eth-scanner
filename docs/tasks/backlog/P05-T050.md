# P05-T050: Implement CompleteBatch() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

## Description

Implement the `CompleteBatch()` function in the worker client to mark a job as completed after the worker has scanned the entire nonce range. This function will send a POST request to `/api/v1/jobs/{job_id}/complete` with the final nonce and total keys scanned.

## Acceptance Criteria

- [ ] `CompleteBatch(ctx context.Context, jobID string, finalNonce uint32, totalKeysScanned uint64)` function added to `Client`
- [ ] Function sends POST request to `/api/v1/jobs/{job_id}/complete`
- [ ] Request includes API key in `X-API-Key` header
- [ ] Request body contains:
  - `worker_id` (string)
  - `final_nonce` (uint32)
  - `keys_scanned` (uint64)
- [ ] Response status 200 OK indicates success
- [ ] Context cancellation is respected
- [ ] Returns descriptive error for failure cases (404, 400, 409, etc.)
- [ ] URL path correctly substitutes `{job_id}` with actual job ID

## Implementation Notes

### Function Signature
```go
package worker

import "context"

func (c *Client) CompleteBatch(ctx context.Context, jobID string, finalNonce uint32, totalKeysScanned uint64) error {
    // Build request
    req := completeRequest{
        WorkerID:    c.workerID,
        FinalNonce:  finalNonce,
        KeysScanned: totalKeysScanned,
    }
    
    // Build path with job_id
    path := fmt.Sprintf("/api/v1/jobs/%s/complete", jobID)
    
    // Make API call
    err := c.doRequestWithContext(ctx, "POST", path, req, nil)
    if err != nil {
        return fmt.Errorf("complete batch failed: %w", err)
    }
    
    return nil
}

// Internal request type
type completeRequest struct {
    WorkerID    string `json:"worker_id"`
    FinalNonce  uint32 `json:"final_nonce"`
    KeysScanned uint64 `json:"keys_scanned"`
}
```

### API Request Example
```json
POST /api/v1/jobs/01234567-89ab-cdef-0123-456789abcdef/complete
X-API-Key: sk_test_1234567890abcdef
Content-Type: application/json

{
  "worker_id": "worker-pc-001",
  "final_nonce": 4294967295,
  "keys_scanned": 4294967296
}
```

### API Response Example (Success)
```
HTTP 200 OK
```

### API Response Example (Errors)
```json
HTTP 404 Not Found
{
  "error": "job not found"
}
```

```json
HTTP 400 Bad Request
{
  "error": "invalid final_nonce",
  "message": "final_nonce must equal nonce_end"
}
```

```json
HTTP 409 Conflict
{
  "error": "worker_id mismatch",
  "message": "job is assigned to different worker"
}
```

```json
HTTP 400 Bad Request
{
  "error": "job already completed"
}
```

## Testing

```bash
cd /home/user/code/garnizeh/eth-scanner/go
go test ./internal/worker -v -run TestCompleteBatch
```

### Test Cases
- Successful batch completion (200 OK)
- Job ID is correctly inserted into URL path
- Request body contains correct worker_id, final_nonce, keys_scanned
- X-API-Key header is included
- Context timeout cancels the request
- 404 error (job not found) returns error
- 400 error (final_nonce doesn't match nonce_end) returns error
- 409 error (worker_id mismatch) returns error
- 400 error (job already completed) returns error
- 401 error (missing/invalid API key) returns error

### Mock Server Test
```go
func TestCompleteBatch(t *testing.T) {
    server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Verify method
        if r.Method != "POST" {
            t.Errorf("expected POST, got %s", r.Method)
        }
        
        // Verify path
        expectedPath := "/api/v1/jobs/test-job-456/complete"
        if r.URL.Path != expectedPath {
            t.Errorf("expected %s, got %s", expectedPath, r.URL.Path)
        }
        
        // Verify API key
        if r.Header.Get("X-API-Key") != "test-key" {
            w.WriteHeader(http.StatusUnauthorized)
            return
        }
        
        // Verify body
        var req completeRequest
        json.NewDecoder(r.Body).Decode(&req)
        if req.WorkerID != "test-worker" {
            t.Errorf("expected worker_id test-worker, got %s", req.WorkerID)
        }
        if req.FinalNonce != 4294967295 {
            t.Errorf("expected final_nonce 4294967295, got %d", req.FinalNonce)
        }
        if req.KeysScanned != 4294967296 {
            t.Errorf("expected keys_scanned 4294967296, got %d", req.KeysScanned)
        }
        
        w.WriteHeader(http.StatusOK)
    }))
    defer server.Close()
    
    client := NewClient(&Config{
        APIURL:   server.URL,
        WorkerID: "test-worker",
        APIKey:   "test-key",
    })
    
    err := client.CompleteBatch(context.Background(), "test-job-456", 4294967295, 4294967296)
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
}
```

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1.3: Complete Job)
- Master API: P04-T090 (implements complete endpoint)
- API key auth: P04-T160
- Related tasks: P05-T020 (Client), P05-T080 (uses CompleteBatch in main loop)
