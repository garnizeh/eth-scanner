# P04-T040: Implement batch creation - create new job with dynamic batch size

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T030  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement the function to create a new job in the database based on worker-requested batch size. This combines the nonce range allocation logic from P04-T030 with inserting a new job record in `pending` status.

---

## Acceptance Criteria

- [ ] Method `CreateBatch(ctx context.Context, prefix28 []byte, batchSize uint32) (*Job, error)` implemented
- [ ] Uses `GetNextNonceRange()` to determine nonce_start and nonce_end
- [ ] Inserts new job with status='pending', current_nonce=nonce_start
- [ ] Initializes keys_scanned=0, worker_id=NULL, expires_at=NULL
- [ ] Returns created job with ID assigned by database
- [ ] Transaction ensures atomicity (allocation + insertion)
- [ ] Unit tests cover: successful batch creation, duplicate prevention

---

## Implementation Notes

**Key Points:**
- Reference SDD: Dynamic batching — workers request batch size based on their capacity
- Use a transaction to prevent race conditions (two workers creating overlapping ranges)
- Created job starts in `pending` status (not assigned to any worker yet)

**Code Flow:**
```go
1. Validate inputs (prefix_28 length, batchSize > 0)
2. Begin transaction
3. Call GetNextNonceRange(prefix28, batchSize)
4. Insert new job record
5. Commit transaction
6. Return created job
```

**SQL Insert:**
```sql
INSERT INTO jobs (
    prefix_28, nonce_start, nonce_end, current_nonce, 
    status, keys_scanned, created_at, updated_at
) VALUES (?, ?, ?, ?, 'pending', 0, ?, ?);
```

---

## Testing

- Test creating first batch for new prefix
- Test creating subsequent batches
- Test transaction rollback on error
- Test concurrent batch creation (ensure no overlapping ranges)

---

## References

- SDD: Section 5.2 — Dynamic Batching
- Database: `internal/database/queries.sql`
- Depends on: P04-T030 (GetNextNonceRange)
