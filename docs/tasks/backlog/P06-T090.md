# P06-T090: Implement context cancellation for lease expiration

**Phase:** P06 - PC Worker - Crypto & Scanning Engine  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P06-T050  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement automatic context cancellation when the job lease is about to expire. The worker should stop scanning gracefully before the lease expires on the master side, allowing time to send a final checkpoint and complete or abandon the job cleanly.

---

## Acceptance Criteria

- [ ] Worker calculates time until lease expiration from `expires_at` field
- [ ] Context with deadline is created: `expires_at - gracePeriod` (e.g., 30 seconds before expiration)
- [ ] Scanner respects context deadline and stops when reached
- [ ] Final checkpoint is sent before context expires
- [ ] Worker logs lease expiration and returns to main loop (requests new batch)
- [ ] Unit tests verify context cancellation at deadline
- [ ] Integration test: worker stops before lease expires on master

---

## Implementation Notes

**Key Points:**
- Reference SDD section: 4.4.2 (Lease Management)
- Grace period: 30-60 seconds before actual expiration
- Use `context.WithDeadline()` to create context with expiration
- All timestamps are UTC (verify `expires_at` is parsed as UTC)
- After expiration: send final checkpoint, then request new lease

**Code Pattern:**
```go
func (w *Worker) processBatch(ctx context.Context, job Job) error {
	// Calculate deadline: expires_at - grace period
	gracePeriod := 30 * time.Second
	deadline := job.ExpiresAt.Add(-gracePeriod)
	
	// Create context with deadline
	scanCtx, cancel := context.WithDeadline(ctx, deadline)
	defer cancel()
	
	// Start checkpoint goroutine
	go w.runCheckpointLoop(scanCtx, job.ID, scanner, job.NonceStart)
	
	// Run scanner
	result, err := w.ScanRangeParallel(scanCtx, job, w.targetAddress)
	if err == context.DeadlineExceeded {
		// Lease expired, send final checkpoint
		log.Printf("lease expired for job %d, stopping", job.ID)
		// Checkpoint already sent by checkpoint goroutine
		return nil
	}
	if err != nil {
		return fmt.Errorf("scan failed: %w", err)
	}
	
	// Mark batch complete
	if result != nil {
		return w.submitResult(ctx, job.ID, result)
	}
	return w.client.CompleteBatch(ctx, job.ID, job.NonceEnd)
}
```

**Time Handling:**
- Parse `expires_at` from API response as UTC: `time.Parse(time.RFC3339, expiresAt)`
- Compare with `time.Now().UTC()`
- Never use `time.Local`

---

## Testing

- Unit test: context cancels at deadline (mock time or short expiration)
- Unit test: scanner stops when context expires
- Unit test: final checkpoint sent after context expiration
- Integration test: worker requests new batch after lease expiration
- Time zone test: verify UTC handling (set TZ=America/New_York and verify behavior)

---

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.4.2)
- Go context package: https://pkg.go.dev/context
- Related tasks: P06-T080 (checkpoint on expiration), P05-T030 (lease API)
