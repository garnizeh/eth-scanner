# P04-T130: Write integration tests for lease endpoint (pending/expired jobs)

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T050  
**Estimated Effort:** Medium (1-3h)

---

## Description

Create comprehensive integration tests for the job lease endpoint that verify the complete flow: leasing pending jobs, re-leasing expired jobs, creating new batches when none available, and handling concurrent lease requests.

---

## Acceptance Criteria

- [ ] Test file `internal/server/jobs_lease_test.go` created
- [ ] Test: Lease pending job (status transitions to processing)
- [ ] Test: Lease expired job (re-assigned to new worker)
- [ ] Test: No jobs available (creates new batch automatically)
- [ ] Test: Concurrent lease requests (no duplicate assignments)
- [ ] Test: Request validation (missing worker_id, invalid batch_size)
- [ ] Test: Response includes correct job data (prefix_28, nonce range, expires_at)
- [ ] All tests use `t.TempDir()` for temporary SQLite database
- [ ] Tests verify UTC timestamps in response

---

## Implementation Notes

**Key Points:**
- Use table-driven tests for different scenarios
- Create helper function to setup test database with sample jobs
- Use `httptest.NewServer` for HTTP testing
- Test concurrent requests using goroutines and sync.WaitGroup

**Test Structure:**
```go
func TestJobLease_PendingJob(t *testing.T) {
    db := setupTestDB(t)
    defer db.Close()
    
    // Insert pending job
    insertTestJob(db, "pending", nil, nil)
    
    // Make lease request
    resp := testLease(t, "worker-1", 1000000)
    
    // Assertions
    assert.Equal(t, 200, resp.StatusCode)
    assert.Equal(t, "processing", resp.Job.Status)
    assert.Equal(t, "worker-1", resp.Job.WorkerID)
    assert.NotNil(t, resp.Job.ExpiresAt)
}
```

---

## Testing

- Run `go test -v ./internal/server -run TestJobLease`
- Verify tests pass consistently
- Check test coverage: `go test -cover`
- Test race conditions: `go test -race`

---

## References

- Testing pattern: Follow existing tests in `internal/server/e2e_test.go`
- Database setup: Use `t.TempDir()` per copilot-instructions.md
- Related: P04-T050 (lease endpoint implementation)
