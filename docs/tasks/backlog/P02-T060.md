# P02-T060: Create database initialization function (apply schema on first run)

**Phase:** P02 - Database Layer Implementation  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P02-T050  
**Estimated Effort:** Medium

---

## Description

Implement a database initialization function that automatically applies the SQL schema (`001_schema.sql`) when the database is first created or when schema needs to be initialized.

This provides a simple migration strategy suitable for the MVP without requiring a full migration framework (goose can be added later in P02-T070).

---

## Acceptance Criteria

- [ ] Create `internal/database/migrate.go` file
- [ ] Implement `ApplySchema(db *sql.DB) error` function
- [ ] Read and execute `internal/database/sql/001_schema.sql`
- [ ] Add idempotency (safe to run multiple times)
- [ ] Use `//go:embed` to embed schema file in binary
- [ ] Add version tracking (simple schema_version table)
- [ ] Proper error handling and rollback on failure
- [ ] Add logging for schema application steps
- [ ] Test on fresh database and existing database

---

## Implementation Notes

```go
package database

import (
    "context"
    "database/sql"
    _ "embed"
    "fmt"
    "strings"
)

//go:embed sql/001_schema.sql
var schemaSQL string

// ApplySchema applies the database schema
// Safe to run multiple times (idempotent)
func ApplySchema(ctx context.Context, db *sql.DB) error {
    // Check if schema is already applied
    var tableExists int
    err := db.QueryRowContext(ctx, 
        "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='jobs'",
    ).Scan(&tableExists)
    
    if err != nil {
        return fmt.Errorf("failed to check schema: %w", err)
    }
    
    if tableExists > 0 {
        // Schema already exists, skip
        return nil
    }
    
    // Execute schema (split by statement if needed)
    _, err = db.ExecContext(ctx, schemaSQL)
    if err != nil {
        return fmt.Errorf("failed to apply schema: %w", err)
    }
    
    return nil
}

// InitDBWithSchema is a convenience function that opens DB and applies schema
func InitDBWithSchema(ctx context.Context, dbPath string) (*sql.DB, error) {
    db, err := InitDB(dbPath)
    if err != nil {
        return nil, err
    }
    
    if err := ApplySchema(ctx, db); err != nil {
        db.Close()
        return nil, err
    }
    
    return db, nil
}
```

**Key Points:**
- Use `//go:embed` to include schema in compiled binary
- Check for existing tables before applying schema (idempotent)
- Handle goose metadata if using goose markers in schema
- Split schema by `-- +goose StatementBegin/End` markers if present
- Enable foreign keys via PRAGMA
- Set journal mode to WAL

**Schema Extraction:**
Since 001_schema.sql contains goose markers, you'll need to:
1. Skip goose comments when applying manually, OR
2. Extract only the CREATE/INDEX statements between StatementBegin/End

---

## Testing

Create a test file `internal/database/migrate_test.go`:

```go
package database

import (
    "context"
    "os"
    "testing"
)

func TestApplySchema(t *testing.T) {
    // Create temporary database
    dbPath := "test_schema.db"
    defer os.Remove(dbPath)
    
    ctx := context.Background()
    
    // Initialize database with schema
    db, err := InitDBWithSchema(ctx, dbPath)
    if err != nil {
        t.Fatalf("Failed to initialize database: %v", err)
    }
    defer db.Close()
    
    // Verify tables exist
    var count int
    err = db.QueryRowContext(ctx, 
        "SELECT COUNT(*) FROM sqlite_master WHERE type='table'",
    ).Scan(&count)
    
    if err != nil {
        t.Fatalf("Failed to query tables: %v", err)
    }
    
    if count < 3 {
        t.Errorf("Expected at least 3 tables, got %d", count)
    }
    
    // Run again (idempotency test)
    err = ApplySchema(ctx, db)
    if err != nil {
        t.Errorf("Schema apply should be idempotent: %v", err)
    }
}
```

---

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4.1: Schema)
- Schema file: `internal/database/sql/001_schema.sql`
- Go embed directive: https://pkg.go.dev/embed
- Related tasks: P02-T050, P02-T070
