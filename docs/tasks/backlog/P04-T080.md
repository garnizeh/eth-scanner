# P04-T080: Implement worker_id validation in checkpoint endpoint

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P04-T070  
**Estimated Effort:** Small (< 1h)

---

## Description

Add security validation to the checkpoint endpoint to ensure only the worker that was assigned a job can update its progress. This prevents malicious or misconfigured workers from corrupting other workers' job state.

---

## Acceptance Criteria

- [ ] Checkpoint handler validates `worker_id` from request matches `jobs.worker_id` in database
- [ ] Returns 403 Forbidden with error message if worker_id mismatch
- [ ] Database query includes `WHERE worker_id = ?` clause
- [ ] Unit test covers worker_id mismatch scenario
- [ ] Integration test verifies worker A cannot checkpoint worker B's job

---

## Implementation Notes

**Key Points:**
- Reference SDD: Security considerations for distributed system
- This prevents race conditions where two workers try to update the same job
- The SQL WHERE clause should include worker_id to make it atomic

**SQL Pattern:**
```sql
UPDATE jobs 
SET current_nonce = ?, keys_scanned = ?, updated_at = ?
WHERE id = ? AND worker_id = ? AND status = 'processing';
```

**Error Response:**
```json
{
  "error": "forbidden: worker_id mismatch",
  "details": "This job is assigned to a different worker"
}
```

**Handler Logic:**
```go
if rowsAffected == 0 {
    // Either job doesn't exist, wrong worker, or not processing
    // Check if job exists to distinguish errors
    job, err := db.GetJob(ctx, jobID)
    if err != nil {
        return 404 // not found
    }
    if job.WorkerID != requestWorkerID {
        return 403 // forbidden
    }
    // ... handle other cases
}
```

---

## Testing

- Test valid checkpoint (worker owns job) → 200 OK
- Test worker A tries to checkpoint worker B's job → 403 Forbidden
- Test checkpointing non-existent job → 404 Not Found
- Test checkpointing job in 'pending' status → 400 Bad Request

---

## References

- Security: Prevent cross-worker interference
- Related: P04-T070 (checkpoint handler implementation)
- Database: Atomic updates with WHERE clause
