# P01-T070: Create Basic Makefile

**Phase:** P01 - Project Foundation & Setup  
**Status:** Not Started  
**Priority:** Low  
**Dependencies:** P01-T010  
**Estimated Effort:** Small (< 45 minutes)

---

## Description

Create a `Makefile` in the `go/` directory to provide convenient shortcuts for common development tasks: building binaries, running tests, generating code with sqlc, initializing the database, and cleaning build artifacts.

This improves developer experience by standardizing commands and ensuring consistent build environments (e.g., enforcing `CGO_ENABLED=0`).

---

## Acceptance Criteria

- [ ] `go/Makefile` file exists
- [ ] `make build` compiles master and worker binaries
- [ ] `make test` runs all unit tests
- [ ] `make sqlc` generates database code
- [ ] `make init-db` initializes SQLite database
- [ ] `make clean` removes build artifacts
- [ ] `make run-master` and `make run-worker` start the respective programs
- [ ] All targets enforce `CGO_ENABLED=0`
- [ ] Makefile includes help/usage target

---

## Implementation Notes

**Create `go/Makefile` with the following content:**

```makefile
# EthScanner Distributed - Makefile
# Provides convenient shortcuts for common development tasks

.PHONY: help build test clean sqlc init-db run-master run-worker fmt lint

# Default target: show help
help:
	@echo "EthScanner Distributed - Available Make Targets"
	@echo ""
	@echo "  make build        - Build master and worker binaries"
	@echo "  make test         - Run all unit tests"
	@echo "  make sqlc         - Generate database code from SQL"
	@echo "  make init-db      - Initialize SQLite database"
	@echo "  make run-master   - Run the Master API server"
	@echo "  make run-worker   - Run the PC Worker"
	@echo "  make fmt          - Format Go code"
	@echo "  make lint         - Run linter (requires golangci-lint)"
	@echo "  make clean        - Remove build artifacts"
	@echo ""

# Build configuration
BINARY_DIR = bin
MASTER_BINARY = $(BINARY_DIR)/master
WORKER_BINARY = $(BINARY_DIR)/worker-pc

# Ensure CGO is disabled for all builds
export CGO_ENABLED = 0

# Go build flags
BUILD_FLAGS = -ldflags="-s -w"

# Build both master and worker
build: $(MASTER_BINARY) $(WORKER_BINARY)
	@echo "✓ Build complete"

# Build master binary
$(MASTER_BINARY): cmd/master/*.go
	@mkdir -p $(BINARY_DIR)
	@echo "Building master..."
	@go build $(BUILD_FLAGS) -o $(MASTER_BINARY) ./cmd/master
	@echo "  → $(MASTER_BINARY)"

# Build worker binary
$(WORKER_BINARY): cmd/worker-pc/*.go
	@mkdir -p $(BINARY_DIR)
	@echo "Building worker..."
	@go build $(BUILD_FLAGS) -o $(WORKER_BINARY) ./cmd/worker-pc
	@echo "  → $(WORKER_BINARY)"

# Run all tests
test:
	@echo "Running tests..."
	@go test -v -race -cover ./...

# Run tests with coverage report
test-coverage:
	@echo "Running tests with coverage..."
	@go test -v -race -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "✓ Coverage report: coverage.html"

# Generate sqlc code
sqlc:
	@echo "Generating sqlc code..."
	@sqlc generate
	@echo "✓ Database code generated"

# Initialize database using shell script
init-db:
	@echo "Initializing database..."
	@../scripts/init-db.sh

# Run master API server
run-master:
	@echo "Starting Master API server..."
	@go run ./cmd/master

# Run PC worker
run-worker:
	@echo "Starting PC Worker..."
	@go run ./cmd/worker-pc

# Format Go code
fmt:
	@echo "Formatting Go code..."
	@go fmt ./...
	@echo "✓ Code formatted"

# Run linter (requires golangci-lint)
lint:
	@echo "Running linter..."
	@golangci-lint run ./...

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	@rm -rf $(BINARY_DIR)
	@rm -f coverage.out coverage.html
	@rm -f ../data/*.db
	@echo "✓ Clean complete"

# Development: build and run master
dev-master: build
	@$(MASTER_BINARY)

# Development: build and run worker
dev-worker: build
	@$(WORKER_BINARY)

# Install development dependencies
deps:
	@echo "Installing development dependencies..."
	@go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
	@echo "✓ Dependencies installed"

# Verify Go environment (no CGO)
verify:
	@echo "Verifying Go environment..."
	@echo "  Go version: $$(go version)"
	@echo "  CGO_ENABLED: $(CGO_ENABLED)"
	@go list -m modernc.org/sqlite > /dev/null 2>&1 && echo "  ✓ modernc.org/sqlite available" || echo "  ✗ modernc.org/sqlite not found"
	@echo "✓ Environment verified"
```

**Key Features:**
- **CGO_ENABLED=0** enforced for all builds
- Build flags include `-s -w` to strip debug info (smaller binaries)
- Separate targets for master and worker
- Development targets (`dev-master`, `dev-worker`) for quick iteration
- Coverage report generation
- Environment verification target

---

## Testing

**How to verify this task is complete:**

1. **Verify Makefile exists:**
   ```bash
   ls -l go/Makefile
   ```

2. **Test help target:**
   ```bash
   cd go/
   make help
   ```

3. **Test individual targets (when dependencies are ready):**
   ```bash
   cd go/
   make verify    # Should work immediately
   make fmt       # Should work if there's any Go code
   make clean     # Should work immediately
   ```

4. **Expected output for `make help`:**
   - Lists all available targets
   - Clean, readable formatting
   - No errors

5. **Expected output for `make verify`:**
   ```
   Verifying Go environment...
     Go version: go version go1.26.x ...
     CGO_ENABLED: 0
     ✓ modernc.org/sqlite available
   ✓ Environment verified
   ```

---

## References

- **GNU Make documentation:** https://www.gnu.org/software/make/manual/
- **SDD:** `docs/architecture/system-design-document.md`
- **Copilot Instructions:** `.github/copilot-instructions.md` (Section 1: Core Tech Stack)
- **Related Tasks:** 
  - P01-T010: Initialize Go module
  - P01-T060: Verify Go toolchain
  - P02-T040: Run sqlc generate (will use `make sqlc`)
  - P03-T060: Create master entrypoint (will use `make run-master`)

---

## Notes

- **Alternative: `justfile`** - Consider using [just](https://github.com/casey/just) instead of make for more ergonomic command runner (optional)
- Makefile uses `.PHONY` to declare non-file targets
- Build flags `-s -w` strip symbol tables and debug info (reduces binary size by ~30%)
- `make build` creates `go/bin/` directory for binaries
- `make clean` removes database files from `data/` directory as well
- Targets like `test`, `build`, `sqlc` will fail until corresponding code exists (expected at this stage)
- **golangci-lint** installation (for `make lint`): 
  ```bash
  # macOS/Linux
  brew install golangci-lint
  # Or
  go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
  ```
- Consider adding CI/CD targets later (e.g., `make ci`, `make docker`)
