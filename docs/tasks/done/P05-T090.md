# P05-T090: Implement retry logic with exponential backoff

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Done  
**Completed:** 2026-02-15  
**Completed By:** Internal Worker implementation (backoff integration, tests, lint fixes)

---

## Summary

This task implemented a configurable exponential backoff helper and integrated it into the PC worker main loop to handle transient failures (no jobs, network errors, server 5xx and 429). The implementation includes jitter (±25%), configurable min/max delays, and a reset-on-success behavior. Unit tests were added to cover the Backoff behavior and retryability logic. Lint and race issues discovered during implementation were fixed.

## Acceptance Criteria

- [x] `Backoff` struct or helper function for managing retry delays
- [x] Exponential backoff algorithm: delay doubles after each failure
- [x] Maximum backoff delay configurable (default: 5 minutes)
- [x] Minimum backoff delay configurable (default: 1 second)
- [x] Jitter added to prevent thundering herd (randomize delay ±25%)
- [x] Backoff resets to minimum after successful operation
- [x] Applied to: No jobs available (`ErrNoJobsAvailable`), network errors during lease request, API errors (5xx/429)
- [x] Does NOT retry on client errors (4xx) except 429

## Implementation summary

- Added `Backoff` helper with configurable `min`/`max` and jitter implemented using secure randomness to satisfy security linters.
- Integrated backoff into `Worker.Run` so the loop backs off on retryable failures and resets on success.
- Added unit tests for `Backoff` behavior and `isRetryable()` logic.
- Fixed lint issues (error comparisons -> `errors.Is`, wrapped `ctx.Err()` returns) and resolved a data race by making shared progress fields atomic in the worker.

Files changed / added (core):

- `go/internal/worker/backoff.go` — new: Backoff implementation and jitter
- `go/internal/worker/backoff_test.go` — new: tests for backoff behavior and jitter bounds
- `go/internal/worker/worker.go` — updated: integrated backoff into `Run`, added `isRetryable` logic and improved error handling
- `go/internal/worker/worker_test.go` — updated/added tests to cover retry behavior and unauthorized/non-retryable paths
- `go/internal/worker/config.go` — updated: added `RetryMinDelay` and `RetryMaxDelay` config fields (with sensible defaults)

## Verification

- Unit tests for `internal/worker` were added and executed locally; `go test ./internal/worker` passes.
- Full repository tests and `make lint` were run locally during development; lint issues were fixed and tests passed.

## Notes & Next steps

- The worker currently uses a simulated scanning placeholder in `processBatch`; replace with the real scanner in P06-T040.
- Optionally expose `RetryMinDelay` and `RetryMaxDelay` via environment variables in `LoadConfig` for runtime tuning.

---

This task has been moved from `docs/tasks/backlog` to `docs/tasks/done` to reflect completion.
