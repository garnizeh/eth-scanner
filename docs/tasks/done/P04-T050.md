# P04-T050: Create POST /api/v1/jobs/lease handler — Done

**Phase:** P04 - Master API - Job Management (Dynamic Batching)
**Status:** Done
**Completed:** 2026-02-15
**Priority:** High
**Dependencies:** P04-T040
**Effort:** Medium (actual ~2h)

---

## Summary

Implemented the `POST /api/v1/jobs/lease` endpoint handler `handleJobLease` in the Master API. The handler validates requests, attempts to lease an existing pending/expired job, and when none are available creates a new batch and leases it to the requesting worker. Added unit/integration tests and fixed a small race in an existing shutdown test. Linting and tests were run locally and passed.

## Acceptance Criteria (completed)

- [x] Handler `handleJobLease` implemented in `internal/server/` (`jobs.go`)
- [x] Accepts POST request with JSON body: `{"worker_id": "...", "requested_batch_size": 1000000}`
- [x] Validates request: `worker_id` non-empty, `batch_size` > 0 and <= max allowed
- [x] Tries to lease existing job via `LeaseExistingJob()`
- [x] If no job available, creates new batch via `CreateBatch()` and leases it
- [x] Returns 200 OK with job JSON on success
- [x] Returns 400 Bad Request for validation errors
- [x] Returns 500 Internal Server Error for database errors
- [x] Route registered in `internal/server/routes.go`
- [x] Integration and unit tests verify the lease flow

## Files changed / added

- `go/internal/server/jobs.go` — new handler and helper `createAndLeaseBatch`
- `go/internal/server/routes.go` — registered `/api/v1/jobs/lease` route
- `go/internal/server/jobs_test.go` — added tests for handler and helper (create+lease, lease existing, validation)
- `go/internal/server/server_test.go` — tightened shutdown test start to avoid race (used Dialer.DialContext)

## How it was verified

- Unit/integration tests run: `go test ./internal/server` — all tests passed locally.
- Project lint passed: `make lint` (0 issues).

Commands to reproduce locally (from repo root):

```bash
cd go
make lint
make test
```

## Notes / Next steps

- Changes were made in the workspace. They should be committed on a task branch following the project workflow: `git checkout main && git pull origin main && git checkout -b task/P04-T050-create-job-lease-handler` then commit and push.
- I did not create or push a branch automatically; if you want I can create the task branch, commit the changes with the task ID in the message, and push a PR.

---

Acceptance criteria met and the task is now complete.
