# P05-T080: Implement worker main loop

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Completed
**Priority:** High
**Dependencies:** P05-T030, P05-T050  
**Estimated Effort:** Medium

---

## Summary

Implemented the PC worker main loop (`Run(ctx)`) that leases jobs, performs scanning (placeholder), sends periodic checkpoints, completes batches and repeats. Added unit tests that exercise the main loop, checkpointing behavior, lease expiry handling and error paths (including unauthorized responses). All tests in `internal/worker` pass locally.

## Acceptance Criteria (completed)

- [x] `Run(ctx context.Context)` function exists in worker package
- [x] Main loop implements the workflow:
  1. Calculate batch size based on throughput
  2. Lease a job from Master API
  3. Start scanning the nonce range (delegate to scanner - P06-T040)
  4. Periodically send checkpoints during scanning
  5. Complete the job when scanning finishes
  6. Repeat from step 1
- [x] Context cancellation gracefully stops the loop
- [x] Handles `ErrNoJobsAvailable` by waiting/retrying
- [x] Handles lease expiration (stops scanning if lease expires)
- [x] Logs progress and errors appropriately
- [x] Graceful shutdown: completes current batch or saves checkpoint before exit

## Files changed

- `go/internal/worker/worker.go` — implemented `Worker.Run` and `processBatch` with checkpointing and lease handling.
- `go/internal/worker/worker_test.go` — added tests:
  - `TestWorkerRun_ProcessesAndCompletesBatch`
  - `TestWorkerRun_LeaseExpiresBeforeCompletion`
  - `TestWorkerRun_LeaseUnauthorizedStops`
  - `TestWorkerRun_LeaseError_ContextCancelledDuringRetry`
  - `TestCheckpointUnauthorizedStopsCheckpointLoop`
  - `TestProcessBatch_CompleteUnauthorizedReturnsErrUnauthorized`

## Testing

Run locally from the `go/` directory:

```bash
go test ./internal/worker -v
```

All tests in the `internal/worker` package passed when implemented.

## Notes / Next work

- Replace the placeholder scanning implementation with the real scanner (P06-T040).
- Add any additional integration tests once the scanner is implemented.

Completed by automated agent changes on 2026-02-15.
