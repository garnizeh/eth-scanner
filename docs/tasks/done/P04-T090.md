# P04-T090: Create POST /api/v1/jobs/{id}/complete handler

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Done
**Priority:** High  
**Completed On:** 2026-02-15

## Summary

Implemented the job completion endpoint allowing workers to mark a job as finished after scanning its nonce range. The handler validates job existence, processing status, worker ownership, and final_nonce equality with the job's nonce_end. Unit tests cover success, worker mismatch (403), final_nonce mismatch (400), and method not allowed (405).

## Acceptance Criteria (completed)
- [x] Handler `handleJobComplete` implemented
- [x] Accepts POST request to `/api/v1/jobs/{id}/complete`
- [x] Request body: `{"worker_id": "...", "final_nonce": 999999, "keys_scanned": 1000000}`
- [x] Validates job exists and is in `processing` status
- [x] Validates `worker_id` matches job's assigned worker
- [x] Validates `final_nonce` equals job's `nonce_end` (enforced)
- [x] Updates job: `status='completed'`, `current_nonce=final_nonce`, `completed_at` (UTC)
- [x] Returns 200 OK with completed job
- [x] Returns 403 Forbidden if worker_id mismatch
- [x] Returns 400 Bad Request if validation fails
- [x] Route registered in `routes.go`

## Implementation notes

- Files changed/added:
  - `go/internal/server/complete.go` — new handler implementation
  - `go/internal/server/complete_test.go` — unit tests (success, worker mismatch, final_nonce mismatch, not found, method not allowed)
  - `go/internal/server/routes.go` — route dispatching for `/complete`
- SQL: `CompleteBatch` query in `go/internal/database/queries.sql.go` performs the atomic update using `WHERE id = ? AND worker_id = ?`.
- Linting and tests: local `make lint` and `make test` passed.

## References

- `go/internal/server/complete.go`
- `go/internal/server/complete_test.go`
- `go/internal/server/routes.go`
- `go/internal/database/sql/queries.sql`
