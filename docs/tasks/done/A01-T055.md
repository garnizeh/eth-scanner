# A01-T055: Add multi-tier statistics retention configuration support — DONE

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Done  
**Priority:** Medium  
**Dependencies:** A01-T050  
**Estimated Effort:** Small (< 1h)

---

## Description

Added configuration support for environment variables controlling retention limits across all statistics tiers and implemented dynamic trigger creation so limits can be changed and applied on DB init.

---

## Acceptance Criteria (completed)

- [x] Add `WorkerHistoryLimit` field to `internal/config/config.go` Config struct  
- [x] Add `WorkerDailyStatsLimit` field (per-worker cap for daily aggregation)  
- [x] Add `WorkerMonthlyStatsLimit` field (per-worker cap for monthly aggregation)  
- [x] Read from environment variables with defaults:
  - `WORKER_HISTORY_LIMIT=10000` (global cap for raw history)
  - `WORKER_DAILY_STATS_LIMIT=1000` (per-worker cap)
  - `WORKER_MONTHLY_STATS_LIMIT=1000` (per-worker cap)
- [x] Validate configuration: all values must be > 0, warn if < 100 (too small)
- [x] Add configuration to `internal/database/connection.go` initialization
- [x] Implement dynamic trigger creation based on configured limits (recreate triggers at DB init)
- [x] Update `README.md` with new environment variable documentation
- [x] Write unit test for config validation (zero value should fail or use default)
- [x] Write integration test verifying limits are respected after configuration change

---

## Implementation Summary

Key changes (files):

- `go/internal/config/config.go` — added three retention fields, env parsing, validation helper `GetRetentionLimits()` and defaults/warnings
- `go/internal/database/connection.go` — calls `GetRetentionLimits()` during `InitDB` and recreates pruning triggers via `createRetentionTriggers` using configured limits
- `go/internal/config/config_test.go` — unit tests including `TestLoad_RetentionZeroUsesDefaults`
- `go/internal/database/connection_triggers_test.go` — integration tests validating pruning and trigger recreation
- `README.md` — documented env vars and added a warning about very small limits

Notes:
- All times and DB operations use UTC as per project conventions.
- Trigger recreation drops both schema-provided trigger names and any runtime triggers before creating the configured triggers.

---

## Tests & Verification

- Unit tests: `go test ./internal/config` — new tests pass
- Integration tests: `go test ./internal/database -run TestRetention*` — new retention tests pass

---

## Progress Log

- 2026-02-16: Implemented config fields, DB trigger creation, README update, unit and integration tests; ran targeted tests locally — all passing. Moved task to `docs/tasks/done`.
