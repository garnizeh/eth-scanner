# P04-T030: Implement nonce range allocation - Done

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P04-T020  
**Estimated Effort:** Medium (1-3h)

---

## Summary

Implemented the nonce range allocation function used to compute the next available nonce range for a 28-byte prefix.

Changes made:

- `go/internal/jobs/manager.go`: added `GetNextNonceRange(ctx context.Context, prefix28 []byte, batchSize uint32) (uint32, uint32, error)` which validates the prefix length, queries prefix usage / highest nonce, computes nonceStart and nonceEnd with overflow checks, and returns errors for invalid inputs or overflow.
- `go/internal/jobs/manager_range_test.go`: added unit tests covering first allocation, subsequent allocation, invalid prefix length, and overflow behavior.

All tests in `internal/jobs` pass locally.

---

## Acceptance Criteria (checked)

- [x] Method `GetNextNonceRange(ctx context.Context, prefix28 []byte, batchSize uint32) (nonceStart, nonceEnd uint32, err error)` implemented
- [x] Query finds MAX(nonce_end) for the given `prefix_28` (via the `GetPrefixUsage` helper in the implementation)
- [x] If no jobs exist for prefix, allocation starts from nonce 0
- [x] Calculates `nonceStart = MAX(nonce_end) + 1`, `nonceEnd = nonceStart + batchSize - 1`
- [x] Handles uint32 overflow and returns an error when the requested range would exceed `math.MaxUint32`
- [x] Validates `prefix_28` is exactly 28 bytes
- [x] Unit tests cover first range, subsequent ranges, overflow detection, and invalid prefix

---

## How to verify locally

```bash
cd go
go test ./internal/jobs -v
```

Or run the full test suite:

```bash
go test ./... -v
```

---

## Notes

- The implementation uses the generated `GetPrefixUsage` SQL query to safely detect whether a prefix has prior batches and to retrieve the highest allocated nonce for that prefix. This avoids ambiguity between SQL NULL and zero return values.
- Future improvement: consider adding a dedicated `GetMaxNonceEndForPrefix` SQL query to avoid scanning prefix usage rows.
