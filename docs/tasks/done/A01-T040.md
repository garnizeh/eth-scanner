# A01-T040: Refactor jobs table schema for long-lived job model

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Done  
**Completed:** 2026-02-16
**Priority:** High  
**Dependencies:** None  
**Estimated Effort:** Medium (1-3h)

---

## Description

Refactor the database schema and job management logic to support long-lived "Macro Jobs" that represent large nonce ranges. Instead of creating a new job row for every small batch request, workers lease and update a single job record as they progress through the range via checkpoints.

This addresses database growth caused by storing every individual batch as a permanent completed job record.

---

## Acceptance Criteria

- [x] Review current `jobs` table schema in `internal/database/sql/001_schema.sql`
- [x] Verify schema supports long-lived job pattern (`current_nonce`, `expires_at`, status transitions)
- [x] Update schema comments documenting the "Macro Job" concept and long-lived job lifecycle
- [x] Ensure indexes are optimized for UPDATE-heavy workload (fewer INSERTs of new jobs)
- [x] Update `internal/jobs/manager.go` to support "find or create macro job" logic
- [x] Write unit tests verifying same job record is reused across multiple checkpoint updates
- [x] Document the new job lifecycle in code comments
- [ ] Delete existing `data/eth-scanner.db` if present (manual)

Note: Deleting the existing SQLite DB is a destructive operation and was left as a manual step; instructions are provided below.

---

## Implementation Notes

- Added SQL queries for macro-job operations (`FindIncompleteMacroJob`, `CreateMacroJob`, `LeaseMacroJob`) in `go/internal/database/sql/queries.sql`.
- Implemented `FindOrCreateMacroJob(ctx, prefix28, workerID)` in `go/internal/jobs/manager.go`. The method finds and leases an existing incomplete macro job or creates a new full-range (0..2^32-1) macro job and leases it to the requester.
- Tests added in `go/internal/jobs/manager_test.go`:
  - `TestFindOrCreateMacroJob_CreateAndReuse` — validates creation and reuse of a macro job
  - `TestFindOrCreateMacroJob_LeaseExpiration` — validates re-lease after expired lease
  - `TestFindOrCreateMacroJob_NilManagerReceiver`, `TestFindOrCreateMacroJob_NilDB`, `TestFindOrCreateMacroJob_InvalidPrefixLength` — negative tests for input validation and nil receivers

---

## How to delete existing DB (manual)

If you want to reset the local database to adopt the macro-job approach from a clean slate, delete the `data/eth-scanner.db` file in the repository root. Example (run locally):

```sh
rm -fv data/eth-scanner.db
```

After deletion, restart the master to allow migrations/seeding to recreate the DB.

---

## Progress Log

- 2026-02-16 - Implemented SQL queries to support macro job operations in `go/internal/database/sql/queries.sql`.
- 2026-02-16 - Added `FindOrCreateMacroJob` to `go/internal/jobs/manager.go` and documented lifecycle in code comments.
- 2026-02-16 - Added unit tests in `go/internal/jobs/manager_test.go` (positive and negative cases). Ran tests locally — all passing.
- 2026-02-16 - Task marked Done; DB deletion left as a manual step (documented above).

---

## Notes

If you want me to perform the DB deletion and push these changes on a task branch, tell me and I will create the branch, delete the DB (after your confirmation), commit, and open a PR.
