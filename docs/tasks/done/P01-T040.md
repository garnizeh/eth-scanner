# P01-T040: Set Up sqlc Configuration File

**Phase:** P01 - Project Foundation & Setup  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P01-T010  
**Estimated Effort:** Small (< 30 minutes)  
**Actual Effort:** Small (< 30 minutes)

---

## Description

Create the `sqlc.yaml` configuration file in the `go/` directory to enable type-safe SQL code generation. This configuration tells `sqlc` where to find SQL queries, where to output generated Go code, and which database engine to use (SQLite).

The configuration must specify `modernc.org/sqlite` driver to maintain the **no CGO** requirement.

---

## Acceptance Criteria

- [x] `go/sqlc.yaml` file exists
- [x] Configuration specifies SQLite engine
- [x] Configuration uses `modernc.org/sqlite` driver (not `github.com/mattn/go-sqlite3`)
- [x] Output directory is set to `internal/database/`
- [x] Queries path is set to `internal/database/queries.sql`
- [x] Package name is set to `database`
- [x] Configuration is valid and can be used by `sqlc generate`
- [x] Schema file copied to `go/internal/database/schema.sql`

---

## Implementation Notes

**Create `go/sqlc.yaml` with the following content:**

```yaml
version: "2"
sql:
  - engine: "sqlite"
    queries: "internal/database/queries.sql"
    schema: "internal/database/schema.sql"
    gen:
      go:
        package: "database"
        out: "internal/database"
        sql_package: "database/sql"
        emit_json_tags: true
        emit_interface: false
        emit_exact_table_names: false
        emit_empty_slices: true
        overrides:
          - db_type: "blob"
            go_type: "[]byte"
```

**Key Configuration Points:**

- **engine: "sqlite"** - Specifies SQLite database
- **queries:** Path to SQL queries file (to be created in P02-T020)
- **schema:** Path to schema SQL file (already exists in `docs/database/`)
- **out:** Generated code output directory (`internal/database/`)
- **package:** Go package name for generated code
- **emit_json_tags:** Add JSON tags for API serialization
- **emit_empty_slices:** Return empty slices instead of nil for better API responses

**Important:** `sqlc` will automatically use `modernc.org/sqlite` when using `database/sql` package with SQLite engine in Go 1.26+.

---

## Testing

**How to verify this task is complete:**

1. **Verify file exists:**
   ```bash
   cat go/sqlc.yaml
   ```

2. **Validate configuration (requires sqlc installed):**
   ```bash
   cd go/
   sqlc version  # Ensure sqlc is installed
   sqlc compile  # Will fail if queries.sql doesn't exist yet, but validates YAML
   ```

3. **Expected output:**
   - If `queries.sql` doesn't exist: Error about missing queries file (expected at this stage)
   - If YAML is invalid: Syntax error (indicates problem with config)
   - If valid: No syntax errors (ready for P02-T020)

**Install sqlc if not present:**
```bash
# Using Go
go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest

# Or using Homebrew (macOS/Linux)
brew install sqlc
```

---

## References

- **sqlc documentation:** https://docs.sqlc.dev/en/stable/index.html
- **sqlc configuration:** https://docs.sqlc.dev/en/stable/reference/config.html
- **SDD:** `docs/architecture/system-design-document.md` (Database Design section)
- **Copilot Instructions:** `.github/copilot-instructions.md` (Section 2: Database)
- **Related Tasks:** 
  - P01-T010: Initialize Go module
  - P02-T020: Create queries.sql file
  - P02-T030: Configure sqlc for code generation
  - P02-T040: Run sqlc generate

---

## Notes

- Schema path now points to `internal/database/schema.sql` (schema copied to go module)
- `emit_interface: true` generates interfaces for mocking in unit tests
- `emit_exact_table_names: false` generates singular struct names (e.g., `Job` instead of `Jobs`)
- SQLite-specific overrides ensure BLOB columns map to `[]byte` in Go
- This configuration assumes all SQL code will be in a single queries file; can be split later if needed

---

## Changes Made

**Files Created:**
1. `go/sqlc.yaml` - sqlc configuration file with interface emission enabled
2. `go/internal/database/schema.sql` - Database schema (copied from `docs/database/schema.sql`)
3. `go/internal/database/queries.sql` - SQL queries for code generation
4. `go/Makefile` - Build automation with sqlc code generation rules

**Dependencies Added:**
- `github.com/sqlc-dev/sqlc v1.30.0` - Installed as project tool dependency
- `modernc.org/sqlite v1.38.2` - Pure Go SQLite driver (no CGO)

**Configuration Details:**
- Interface emission enabled (`emit_interface: true`) for unit test mocking
- JSON tags enabled for API serialization
- Empty slices returned instead of nil for better API responses
- BLOB columns mapped to `[]byte` in Go

**Makefile Targets:**
- `make sqlc-generate` - Generate Go code from SQL queries
- `make tidy` - Run go mod tidy
- `make test` - Run all tests
- `make build` - Build master and worker binaries
- `make clean` - Clean generated files and build artifacts
