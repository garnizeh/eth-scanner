# A01-T020: Master background cleanup for abandoned leases

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Completed
**Priority:** Medium  
**Dependencies:** A01-T010  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement a background cleanup task in the Master API that identifies jobs with leases that have been stale (no checkpoint updates) for an extended period (e.g., 7 days) and removes the `worker_id` assignment, allowing other workers to pick up the work.

## Acceptance Criteria (completed)

- [x] Master runs a background goroutine/ticker that periodically checks for stale jobs
- [x] Configurable threshold for staleness (default: 7 days, via environment variable `MASTER_STALE_JOB_THRESHOLD`)
- [x] SQL query identifies jobs in `processing` state where `last_checkpoint_at` is older than threshold
- [x] Cleanup operation updates stale jobs: set `worker_id = NULL`, `status = 'pending'`, and reset `expires_at = NULL`
- [x] Background task runs every configurable interval (default: 6 hours, via `MASTER_CLEANUP_INTERVAL`)
- [x] Log cleanup actions with job ID and old worker_id for audit trail
- [x] Unit tests verify cleanup logic (mock time for deterministic tests)
- [x] Integration test confirms stale jobs are reassigned after threshold

---

## Implementation Notes (what was changed)

- Added SQL query `CleanupStaleJobs` in `internal/database/sql/queries.sql` and generated code via `sqlc`.
- Extended `internal/config/config.go` with `StaleJobThresholdSeconds` and `CleanupIntervalSeconds` and ENV parsing for `MASTER_STALE_JOB_THRESHOLD` and `MASTER_CLEANUP_INTERVAL`.
- Started a background cleanup goroutine in `internal/server/server.go` that runs at the configured interval and invokes the query.
- Added unit test `TestCleanupStaleJobs` in `internal/database/queries_test.go` to validate cleanup behavior.
- Updated related tests and fixed lint issues arising from the changes.

---

## Progress Log

- Implemented `CleanupStaleJobs` SQL and regenerated sqlc code.
- Added config fields and parsing with defaults (7 days / 6 hours).
- Implemented background cleanup goroutine in server startup; respects context for graceful shutdown.
- Wrote `TestCleanupStaleJobs` to assert stale jobs are reset to `pending` and `worker_id` is cleared.
- Ran `go test` for affected packages and resolved linter warnings introduced during edits.

---

## Notes & Next Steps

- Monitor cleanup logs in staging to ensure the threshold is conservative enough for production workloads.
- Optional: expose a manual admin API to trigger cleanup and add a Prometheus metric for cleaned job counts.
