# P05-T050: Implement CompleteBatch() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

Summary
-------
Implemented `CompleteBatch()` in the worker client (`go/internal/worker/client.go`) and added unit tests covering success and failure cases. The implementation:

- Sends POST /api/v1/jobs/{job_id}/complete with `worker_id`, `final_nonce` and `keys_scanned`
- Includes optional `X-API-Key` header when configured
- Returns HTTP 200 as success
- Returns sentinel `ErrUnauthorized` for HTTP 401 so the worker can stop when auth fails
- Wraps lower-level errors for easier inspection by callers

Tests added in `go/internal/worker/client_test.go` include:

- Successful complete batch request and verification of HTTP method, path, headers, and request body
- 401 -> `ErrUnauthorized`
- 400/other non-2xx responses wrapped as `*APIError` and surfaced as `complete batch failed: ...`

Notes
-----
- Code is formatted and tests were written to follow project testing/lint rules (check encoder errors, use `errors.Is`/`errors.As`).
- Wiring `CompleteBatch()` into the worker runtime (to call when job scanning finishes) is a separate task (P05-T080).

Files changed (summary)
- `go/internal/worker/client.go` — added `CompleteBatch()` and `completeRequest` type
- `go/internal/worker/client_test.go` — added tests for CompleteBatch behavior

Acceptance Criteria (checked)

- [x] `CompleteBatch(ctx context.Context, jobID string, finalNonce uint32, totalKeysScanned uint64)` function added to `Client`
- [x] Function sends POST request to `/api/v1/jobs/{job_id}/complete`
- [x] Request includes API key in `X-API-Key` header (optional)
- [x] Request body contains `worker_id`, `final_nonce`, `keys_scanned`
- [x] Response status 200 OK indicates success
- [x] Context cancellation respected (requests use context)
- [x] Returns descriptive/wrapped error for failure cases
- [x] URL path correctly substitutes `{job_id}` with actual job ID

---

Completed by: automated agent (copilot) with user review steps
