# A01-T065: Update PC Worker client to support long-lived jobs and metrics reporting

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Done  
**Priority:** High  
**Dependencies:** A01-T060  
**Estimated Effort:** Medium (1-3h)

---

## Description

Update the PC Worker client to support the long-lived job model: maintain a single job assignment, process locally in small internal chunks, and report progress and performance metrics via periodic checkpoints.

---

## Acceptance Criteria (completed)

- [x] Update `cmd/worker-pc/main.go` to maintain job state across multiple internal batches
- [x] Modify worker loop to process large jobs in small chunks locally
- [x] Send checkpoint requests periodically (e.g., every N keys or M seconds) instead of completing immediately
- [x] Include performance metrics in checkpoint/complete requests: `started_at`, `duration_ms`, `keys_scanned`
- [x] Track batch start time and calculate duration before sending checkpoint
- [x] Handle lease expiration gracefully (re-request work if checkpoint fails with 410 Gone)
- [x] Update worker configuration to support checkpoint interval settings
- [x] Write unit tests for metrics calculation (keys_scanned, duration_ms, throughput)
- [x] Write integration test for full worker lifecycle with multiple checkpoints

---

## Implementation notes / artifacts

Changes made (high level):

- Worker: `go/internal/worker/worker.go` — process long-lived leases in internal chunks, chunk-level checkpoints, ticker-based checkpoints, HTTP 410 handling (returns `ErrLeaseExpired`).
- Client: `go/internal/worker/client.go` — checkpoint and complete payloads include `started_at`, `duration_ms`, `keys_scanned`.
- Config: `go/internal/worker/config.go` — added `WORKER_INTERNAL_BATCH_SIZE` environment variable and loading; `CheckpointInterval` already supported.
- Types: `go/internal/worker/worker_state.go` — `State` and `RuntimeConfig` types.
- Metrics helpers: `go/internal/worker/metrics.go`.
- Tests added/updated:
  - `go/internal/worker/metrics_test.go` (unit: throughput/duration)
  - `go/internal/worker/worker_integration_test.go` (integration: Lease → multiple checkpoints → Complete)
  - `go/internal/worker/worker_test.go` (added tests for 410 re-request and ticker checkpoint behavior)
- Docs/Makefile: `README.md` and `go/Makefile` updated to document/export new env vars.

Notes:
- An end-to-end test that asserts N records in `worker_history` requires running the Master API with a test database or an integrated test harness; this is recommended as a follow-up E2E task.

---

## Progress Log

- 2026-02-16: Implemented long-lived job processing, chunk checkpointing, ticker checkpointing, checkpoint payload metrics, added unit and integration tests, updated docs and Makefile.

---

## Follow-ups (optional)

- Create an E2E test that runs the Master API against a temporary SQLite DB and asserts worker_history entries after checkpoints.
- Create a task-branch and push these changes for code review if desired.
