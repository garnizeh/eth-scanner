# P05-T040: Implement UpdateCheckpoint() function

**Phase:** P05 - PC Worker - Core Implementation  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P05-T020  
**Estimated Effort:** Small

---

Summary
-------
Implemented `UpdateCheckpoint()` in the worker client (`go/internal/worker/client.go`) and added unit tests covering success and failure cases. The implementation:

- Sends PATCH /api/v1/jobs/{job_id}/checkpoint with `worker_id`, `current_nonce` and `keys_scanned`
- Includes optional `X-API-Key` header when configured
- Returns HTTP 200 as success
- Returns sentinel `ErrUnauthorized` for HTTP 401 so the worker can stop when auth fails
- Wraps lower-level errors (URL parse, JSON marshal/unmarshal, API error) for easier inspection by callers

Tests added in `go/internal/worker/client_test.go` include:

- Successful checkpoint update and verification of HTTP method, path, headers, and request body
- 401 -> `ErrUnauthorized`
- 409/other non-2xx responses wrapped as `*APIError` and surfaced as `checkpoint update failed: ...`

Notes
-----
- Code is formatted and tests were written with the project's testing/lint rules in mind (check encoder errors, use `errors.Is`/`errors.As`, deterministic behavior in tests).
- No changes were made to runtime loop yet — wiring `ErrUnauthorized` handling into the worker main loop is a separate task (P05-T080 or similar).

Files changed (summary)
- `go/internal/worker/client.go` — added `UpdateCheckpoint()` and `checkpointRequest` type
- `go/internal/worker/client_test.go` — added tests for checkpoint behavior

Acceptance Criteria (checked)

- [x] `UpdateCheckpoint(ctx context.Context, jobID string, currentNonce uint32, keysScanned uint64)` function added to `Client`
- [x] Function sends PATCH request to `/api/v1/jobs/{job_id}/checkpoint`
- [x] Request includes API key in `X-API-Key` header (optional)
- [x] Request body contains `worker_id`, `current_nonce`, `keys_scanned`
- [x] Response status 200 OK indicates success
- [x] Context cancellation respected (requests use context)
- [x] Returns descriptive/wrapped error for failure cases
- [x] URL path correctly substitutes `{job_id}` with actual job ID

---

Completed by: automated agent (copilot) with user review steps
