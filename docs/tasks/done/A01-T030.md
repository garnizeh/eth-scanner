# A01-T030: Worker dynamic batch size adjustment based on target duration

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Completed
**Priority:** Medium  
**Dependencies:** None  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement adaptive batch sizing in the PC worker so the worker adjusts its
`requested_batch_size` based on measured job duration versus a configurable
target duration (default: 1 hour). This reduces round-trips and lowers the
risk of lease expiration while adapting to different hardware throughput.

## Acceptance Criteria (completed)

- [x] Worker configuration includes `WORKER_TARGET_JOB_DURATION`, `WORKER_MIN_BATCH_SIZE`, `WORKER_MAX_BATCH_SIZE` and related vars
- [x] Worker measures batch start/end time and computes actual duration
- [x] Worker computes adjustment factor `target / actual` and applies smoothing
- [x] Worker updates internal `batch_size` for the next lease and clamps to min/max
- [x] Unit tests added for adjustment logic and clamping
- [x] Integration / e2e validation performed locally (unit-level + e2e cleanup test independent)

---

## Implementation Notes (what was changed)

- Added config fields and env parsing in `internal/worker/config.go`:
  - `TargetJobDurationSeconds`, `MinBatchSize`, `MaxBatchSize`, `BatchAdjustAlpha`, `InitialBatchSize`
- Implemented `AdjustBatchSize` helper in `internal/worker/batch.go` (smoothing + clamping).
- Updated worker runtime to track `batchSize` state and initialize from config or `CalculateBatchSize`.
- Modified `processBatch` to return elapsed duration and keys scanned so the caller can update throughput estimates.
- After each completed batch `Run()` adjusts `batchSize` using `AdjustBatchSize` and updates `measuredThroughput`.
- Added unit tests `internal/worker/batch_adjust_test.go` and updated `internal/worker/config_test.go` to cover defaults and env overrides.
- Updated `internal/worker/worker_test.go` to match new `processBatch` return signature and ensure existing behavior still passes.

---

## Progress Log

- Implemented adaptive sizing logic and config parsing.
- Added unit tests for adjustment and clamping; ran worker package tests locally.
- Updated worker behavior to persist `batchSize` between iterations and to compute measured throughput.

---

## Notes & Next Steps

- Monitor worker logs in staging for convergence and tune `WORKER_BATCH_ADJUST_ALPHA` if oscillation observed.
- Add integration test that runs a worker against the master for several iterations to assert convergence (planned P09).
