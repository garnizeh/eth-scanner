---
id: A01-T120
title: Improve worker checkpointing, progress updates, and hot-path efficiency
status: Completed
owner: GitHub Copilot
created: 2026-02-19
tags:
  - worker
  - performance
  - reliability
---

## Summary

Implement multiple improvements to `processBatch` to increase robustness and efficiency: per-checkpoint timeouts, throttled/batched progress updates, per-call timeouts for result submission, reduced hot-path logging, guarding `w.config` usage, and micro-optimizations around atomics and allocations.

## Motivation

`processBatch` runs in a hot loop and interacts with the network and shared counters. At high throughput this can cause blocked network calls, excessive atomic operations, and noisy logging which reduce scanning throughput and increase latency. These improvements will make the PC worker more robust under load and easier to test and operate.

## Acceptance criteria

- Periodic checkpoint calls use a short per-call timeout (e.g., 5-10s) and handle timeouts as expected.
- Final checkpoint retains a longer timeout (10s) as currently implemented.
- `SubmitResult` is called with a short per-call timeout to avoid blocking the worker.
- `progressFn` updates are throttled or batched (configurable) to reduce atomic operations while preserving reasonable telemetry frequency.
- Logging in hot paths (per-chunk checkpoint, frequent progress) is reduced or made rate-limited/configurable.
- `w.config` is guarded or ensured non-nil to avoid panics (document the chosen approach).
- Micro-optimizations considered: local accumulators, reduced allocations, reuse of `Job` struct where sensible.
- Add unit tests covering checkpoint timeouts, unauthorized handling during checkpoint, and progress-throttling behavior.
- Update docs describing the new config knobs and operational behavior.

## Implementation notes

1. Add config knobs to `Config` (`WORKER_CHECKPOINT_TIMEOUT`, `WORKER_PROGRESS_THROTTLE_MS`, optionally `WORKER_LOG_SAMPLING`) with sensible defaults.
2. Use `context.WithTimeout` for each periodic checkpoint call (timeout from config). The final checkpoint keeps a longer hardcoded timeout (10s) or reads from config.
3. Change `progressFn` behavior: allow callers to aggregate locally and call the progress callback every N keys or every X milliseconds. Add tests and make throttling configurable.
4. Wrap `SubmitResult` with `context.WithTimeout` to a small timeout and handle timeout as non-fatal (log) unless unauthorized.
5. Replace frequent `log.Printf` calls in the hot path with a rate-limited logger or conditional debug-level logging via an env var.
6. Ensure `NewWorker` enforces `config != nil` (or add local defaults in `processBatch`) to avoid panics when reading `w.config.*`.
7. Add unit tests (httptest servers) that simulate slow/stalled Master API responses to assert timeouts are handled and errors are wrapped correctly.
8. Benchmark the scanner end-to-end before/after changes to verify that throughput is not negatively impacted; prefer microbenchmarks for `progressFn` changes.

## Steps

1. Add config fields and env parsing in `go/internal/worker/config.go`.
2. Implement per-checkpoint timeouts and per-call timeouts in `processBatch`.
3. Implement progress update throttling and expose config for tuning.
4. Reduce or rate-limit hot-path logging.
5. Add unit tests for timeouts, unauthorized handling, invalid progress values, and behavior when `WORKER_NUM_GOROUTINES` is set.
6. Run tests and benchmarks; adjust defaults as needed.
7. Update `docs/tasks/backlog/A01-T120.md` and README worker run section to document new env vars and behaviors.


## Notes

- Follow existing project testing requirements: use `httptest.NewServer` to simulate API behavior and assert wrapped errors with `errors.Is`/`errors.As`.
- Keep changes minimal and focused; avoid refactoring unrelated logic.
- Use UTC and deterministic time handling in tests.
