# P02-T020: Create queries.sql with all sqlc queries

**Phase:** P02 - Database Layer Implementation  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P02-T010  
**Estimated Effort:** Medium

---

## Description

Create `go/internal/database/sql/queries.sql` containing all sqlc query definitions for the Master API and workers. This file uses sqlc annotations to generate type-safe Go code for database operations.

---

## Acceptance Criteria

- [x] Create `internal/database/sql/queries.sql` file
- [x] Query: FindAvailableBatch (lease/expired jobs)
- [x] Query: GetNextNonceRange (find next range for prefix)
- [x] Query: CreateBatch (insert new job)
- [x] Query: LeaseBatch (update existing job to processing)
- [x] Query: UpdateCheckpoint (progress tracking)
- [x] Query: CompleteBatch (mark job completed)
- [x] Query: GetJobByID, GetJobsByWorker, GetJobsByStatus
- [x] Query: InsertResult (found private key)
- [x] Query: GetResultByPrivateKey, GetResultsByAddress, GetAllResults
- [x] Query: UpsertWorker (heartbeat)
- [x] Query: UpdateWorkerKeyCount
- [x] Query: GetWorkerByID, GetActiveWorkers, GetWorkersByType
- [x] Query: GetStats (from view)
- [x] Query: GetPrefixUsage, GetWorkerStats
- [x] All queries use proper sqlc annotations (:one, :many, :exec)
- [x] UTC datetime functions used (datetime('now', 'utc'))

---

## Implementation Notes

All required queries have been implemented in `/home/user/code/garnizeh/eth-scanner/go/internal/database/sql/queries.sql`:

**Job Management Queries:**
- `FindAvailableBatch` - Find pending or expired jobs
- `GetNextNonceRange` - Get next available nonce range for prefix
- `CreateBatch` - Create new job with lease
- `LeaseBatch` - Lease existing pending job
- `UpdateCheckpoint` - Update progress during scanning
- `CompleteBatch` - Mark job as completed

**Result Queries:**
- `InsertResult` - Save found private key
- `GetResultByPrivateKey` - Verify existing result
- `GetResultsByAddress` - Search by Ethereum address

**Worker Queries:**
- `UpsertWorker` - Register/update worker heartbeat
- `UpdateWorkerKeyCount` - Increment total keys scanned
- `GetActiveWorkers` - Find workers active in last N minutes

**Statistics Queries:**
- `GetStats` - Get aggregated stats from view
- `GetPrefixUsage` - Prefix scanning progress
- `GetWorkerStats` - Per-worker statistics

**sqlc Annotations Used:**
- `:one` - Single row result
- `:many` - Multiple rows result
- `:exec` - No result (UPDATE/INSERT)

---

## Testing

Queries will be tested after sqlc code generation (P02-T040) and in unit tests (P02-T080).

---

## References

- SDD: `docs/architecture/system-design-document.md` (Section 5: API Endpoints)
- sqlc documentation: https://docs.sqlc.dev/
- Queries file: `internal/database/sql/queries.sql`
- Related tasks: P02-T030, P02-T040
