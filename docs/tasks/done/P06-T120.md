# Task: P06-T120 - Replace worker simulation with real job processing â€” DONE

## Status
- Completed: 2026-02-16

## Summary
Replaced the PC worker's simulated scanning loop with the real, parallel scanner and added checkpointing, result submission, and observability improvements. The implementation integrates `ScanRangeParallel` into `Worker.processBatch`, reports progress via an atomic-backed callback, submits matches to the Master API, and logs throughput and worker parallelism.

## Acceptance Criteria (all completed)
- [x] Replace `time.After` simulation in `Worker.processBatch` with a call to `ScanRangeParallel`.
- [x] Implement a mechanism for `ScanRangeParallel` to periodically report `current_nonce` and `keys_scanned` back to the worker's checkpointing goroutine (atomic counters + progress callback).
- [x] Ensure the worker can handle and submit results if a matching private key is found (via `Client.SubmitResult`).
- [x] Plumbing: `JobLease` and server lease response include `target_address`; worker uses it (defaults to dead address if not set).
- [x] Verify that the worker now takes a realistic amount of time to complete a batch (benchmarks/reference runs observed).

## Files changed
- `go/internal/worker/worker.go`: replaced simulation with call to `ScanRangeParallel`, added progress callback handling, propagated `ErrUnauthorized` from checkpoint loop, added throughput and goroutine-count logs.
- `go/internal/worker/scanner.go`: `ScanRangeParallel` updated to accept a progress callback and report per-chunk progress (already present in this change set).
- `go/internal/worker/client.go`: `JobLease` and `leaseResponse` include `TargetAddress` (parsed by the client).
- `go/internal/config/config.go`: added `TargetAddress` config option and env var.
- `go/internal/config/config_test.go`: added tests for new config behavior.
- `go/internal/worker/*_test.go`: updated tests to reflect new `ScanRangeParallel` signature and added/fixed tests related to checkpoint/unauthorized handling.

## How it was validated
- Unit tests run: `go test ./internal/worker -run TestCheckpointUnauthorizedStopsCheckpointLoop -v` (passes).
- Iterative `make test` executed during development; relevant package tests pass locally.
- Manual runtime check: rebuilt worker and observed realistic scanning logs indicating periodic checkpoints, final checkpoints, and throughput logs like `rate=XXXX keys/s`.

## Notes and follow-ups
- The worker now logs the number of goroutines used (from `runtime.NumCPU()`) and the measured throughput for each scanned batch.
- Next suggested steps: push the branch, open a PR, and run CI/full test suite on remote. Also run end-to-end test with the Master API to validate leases from a deployed server.

## Commit / Branch
- Local branch: `task/P06-T120-real-job-processing` (changes committed locally).
