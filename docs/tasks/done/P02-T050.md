# P02-T050: Implement database connection layer with modernc.org/sqlite

**Phase:** P02 - Database Layer Implementation  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P02-T040  
**Estimated Effort:** Medium

---

## Description

Implement a custom database connection layer in `internal/database/connection.go` that provides SQLite database access using the pure Go `modernc.org/sqlite` driver (no CGO required).

This file will provide:
- Database connection initialization
- Connection pool configuration
- Helper functions to access the sqlc-generated queries
- Proper resource cleanup

---

## Acceptance Criteria

- [x] Create `internal/database/connection.go` file
- [x] Implement `InitDB(dbPath string) (*sql.DB, error)` function
- [x] Import `_ "modernc.org/sqlite"` driver
- [x] Configure connection pool settings (max open connections, max idle connections)
- [x] Add `NewQueries(db *sql.DB) *Queries` helper function
- [x] Verify CGO_ENABLED=0 works correctly with the connection
- [x] Add proper error handling and logging
- [x] Test manual connection and query execution

---

## Implementation Notes

```go
package database

import (
    "database/sql"
    "fmt"
    
    _ "modernc.org/sqlite" // Pure Go SQLite driver
)

// InitDB initializes a SQLite database connection
// Returns *sql.DB ready for use with sqlc queries
func InitDB(dbPath string) (*sql.DB, error) {
    // Open connection with modernc.org/sqlite
    db, err := sql.Open("sqlite", dbPath)
    if err != nil {
        return nil, fmt.Errorf("failed to open database: %w", err)
    }
    
    // Configure connection pool
    db.SetMaxOpenConns(1)  // SQLite works best with single writer
    db.SetMaxIdleConns(1)
    
    // Test connection
    if err := db.Ping(); err != nil {
        return nil, fmt.Errorf("failed to ping database: %w", err)
    }
    
    return db, nil
}

// NewQueries creates a Queries instance from database connection
func NewQueries(db *sql.DB) *Queries {
    return New(db)
}
```

**Key Requirements:**
- Use `modernc.org/sqlite` (pure Go, no CGO)
- Connection string format: `file:test.db?cache=shared&mode=rwc`
- Set MaxOpenConns=1 (SQLite limitation)
- Enable Write-Ahead Logging (WAL) for better concurrency
- UTC timezone handling via PRAGMA

---

## Testing

Manual test:
```go
package main

import (
    "log"
    "your-project/internal/database"
)

func main() {
    db, err := database.InitDB("test.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()
    
    queries := database.NewQueries(db)
    
    // Test query
    stats, err := queries.GetStats(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    
    log.Printf("Stats: %+v", stats)
}
```

---

## References

- SDD: `docs/architecture/system-design-document.md` (Section 4: Database Design)
- modernc.org/sqlite documentation: https://pkg.go.dev/modernc.org/sqlite
- Related tasks: P02-T040, P02-T060
