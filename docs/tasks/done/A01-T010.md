# A01-T010: Worker-specific prefix affinity for nonce exhaustion

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Completed  
**Priority:** High  
**Dependencies:** None  
**Estimated Effort:** Medium (1-3h)

---

## Description

Implement worker-specific prefix affinity so that when a worker completes a batch and requests a new lease, the master continues allocating nonce ranges from the same prefix (vertical exhaustion) instead of creating new random prefixes (horizontal fragmentation).

## Acceptance Criteria (result)

- [x] Master tracks the last prefix assigned to each `worker_id` (database-backed sqlc query)
- [x] When a worker requests a lease, the master checks if that worker has an incomplete prefix
- [x] If the worker has an incomplete prefix (highest `nonce_end` < 2^32-1), the master allocates the next nonce range from that prefix
- [x] If the worker's prefix is exhausted the master assigns a new prefix
- [x] New workers get a new random prefix or reuse a pending prefix with available space
- [x] Unit tests verify sequential nonce allocation for the same worker across multiple leases
- [x] Integration test confirms multiple workers exhaust their assigned prefixes independently

---

## Implementation Summary

- Added sqlc query `GetWorkerLastPrefix` to `internal/database/sql/queries.sql` to return the worker's last prefix and highest nonce_end.
- Updated `createAndLeaseBatch` in `internal/server/jobs.go` to prefer reusing the worker's last prefix (if it has remaining nonces) when the worker does not provide an explicit `prefix_28`.
- Added safe conversion/guards for the generated sqlc type and reduced nesting to satisfy linters.
- Updated lease tests in `internal/server/jobs_lease_test.go` to assert worker-specific prefix affinity.

---

## Verification

- Ran server package tests: `go test ./internal/server -v` — all tests passed.
- Ran linter and fixed issues: `make lint` — no lint issues.

---

## Progress Log

### 2026-02-16 - Implementation
- Implemented DB query and server changes to enable worker-prefix affinity.
- Updated tests and fixed linter findings (gosec and nestif) by adding safe type handling and refactoring.

### 2026-02-16 - Verification
- Server tests passed locally. Linting passes.

---

## Notes & Next Steps

- Consider adding a small `prefixes` pool table for more deterministic prefix assignment in future.
- Consider reassignment heuristics for long-idle workers (optional enhancement).
