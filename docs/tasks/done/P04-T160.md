# P04-T160: Add API key middleware for master API

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Completed
**Priority:** Medium  
**Dependencies:** P04-T150  
**Estimated Effort:** Medium (1-3h)

---

## Description

Protected the master API by adding middleware that requires every incoming request to present a valid API key in the `X-API-KEY` header. The key is configured via environment variable `MASTER_API_KEY` and loaded into `config.Config` during startup.

---

## Acceptance Criteria

- [x] Middleware validates `X-API-KEY` header and rejects missing/invalid values with `401 Unauthorized`
- [x] API key value stored in `config.Config` after being read from environment variable `MASTER_API_KEY`
- [x] Middleware registered for all server routes
- [x] Tests cover valid request, missing header, and invalid key scenarios
- [x] Updated documentation/config notes describing how to set the API key env var

---

## Implementation Notes

- Implemented `apiKeyMiddleware` in `internal/server/middleware.go`.
- Added `APIKey` field to `config.Config` and populated from `MASTER_API_KEY` in `config.Load`.
- Enforced middleware in `internal/server/routes.go`.
- Added comprehensive unit tests in `internal/server/middleware_test.go` covering all scenarios.

---

## How verified

Ran all server tests:

```bash
cd go
go test ./internal/server -v
```

All tests, including the new API key middleware tests, passed successfully.
