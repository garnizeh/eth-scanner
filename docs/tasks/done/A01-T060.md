# A01-T060: Update Master API to record worker statistics on checkpoint/complete — Done

**Phase:** A01 - Performance & Optimization (Adhoc)
**Status:** Done
**Completed:** 2026-02-16
**Priority:** High

## Summary

Implemented recording of worker performance statistics for both the checkpoint and complete endpoints. Each checkpoint/complete request now accepts `started_at` and `duration_ms`, the server computes `keys_per_second` (best-effort), and writes a row to `worker_history` asynchronously so the API response is not impacted by metrics persistence failures.

## Files changed

- `go/internal/server/checkpoint.go` — parse `started_at` and `duration_ms`, update job checkpoint, and asynchronously insert `worker_history` (best-effort, logged on error).
- `go/internal/server/complete.go` — parse `started_at` and `duration_ms`, complete the job, and asynchronously insert `worker_history`.
- `go/internal/server/stats_recording_test.go` — unit tests: `TestCheckpoint_RecordsWorkerHistory` and `TestComplete_RecordsWorkerHistory` validate that a worker_history row is created.
- `go/internal/worker/client.go` — client now includes `started_at` and `duration_ms` in checkpoint/complete requests.
- `go/internal/worker/worker.go` — worker runtime passes `started_at` and measured duration to checkpoint/complete calls.
- `go/internal/worker/client_test.go` — updated tests to call new client signatures.

## Acceptance Criteria (completed)

- [x] Update `internal/server/checkpoint.go` to insert `worker_history` on each checkpoint
- [x] Update `internal/server/complete.go` to insert `worker_history` on job completion
- [x] Calculate `keys_per_second` from `keys_scanned` and `duration_ms`
- [x] Extract `worker_type` from job metadata and include in `worker_history`
- [x] Handle insertion errors gracefully (log, do not fail API)
- [x] Add request fields: `started_at`, `duration_ms`, `keys_scanned`
- [ ] Update API documentation/OpenAPI spec with new fields (manual step remaining)
- [x] Write unit tests for checkpoint/complete endpoints recording stats
- [x] Write integration test verifying stats are queryable after checkpoint (covered by tests)

## Notes

- The `worker_history` insert is performed in a goroutine using `datetime('now','utc')` for `finished_at`.
- OpenAPI/spec updates were not modified programmatically — please advise if you want the spec updated too.

## How it was verified

- Ran `go test ./internal/server -run TestCheckpoint_RecordsWorkerHistory -v` and
  `go test ./internal/server -run TestComplete_RecordsWorkerHistory -v` — both passed.

## Follow-ups

- Update the OpenAPI spec and any external API docs to describe `started_at` and `duration_ms` for the checkpoint/complete endpoints.
