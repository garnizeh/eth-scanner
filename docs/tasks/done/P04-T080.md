# P04-T080: Implement worker_id validation in checkpoint endpoint

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Done
**Priority:** High  
**Completed On:** 2026-02-15

## Summary

Implemented worker_id validation for the checkpoint endpoint. The handler ensures only the worker assigned to a job can update its checkpoint; the database update is atomic because the SQL includes `WHERE id = ? AND worker_id = ? AND status = 'processing'`.

## Acceptance Criteria (completed)
- [x] Checkpoint handler validates `worker_id` from request matches `jobs.worker_id` in database
- [x] Returns 403 Forbidden with error message if worker_id mismatch
- [x] Database query includes `WHERE worker_id = ?` clause (see `UpdateCheckpoint` SQL)
- [x] Unit test covers worker_id mismatch scenario (`go/internal/server/checkpoint_test.go`)
- [x] Integration behavior verified via unit tests and full test suite

## Implementation notes

- The `UpdateCheckpoint` SQL in `go/internal/database/sql/queries.sql` already contains the `worker_id` condition to make the update atomic.
- The handler `go/internal/server/checkpoint.go` fetches the job and checks status and worker_id, returning 403 when they don't match.
- Unit test `TestHandleJobCheckpoint_WorkerMismatch` asserts 403 Forbidden when a different worker attempts to checkpoint a job.

## References

- `go/internal/server/checkpoint.go`
- `go/internal/server/checkpoint_test.go`
- `go/internal/database/sql/queries.sql` (UpdateCheckpoint)
