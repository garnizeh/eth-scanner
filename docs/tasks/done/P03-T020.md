# P03-T020: Implement internal/server/server.go

**Phase:** P03 - Master API - Core Infrastructure  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P03-T010  
**Estimated Effort:** Medium

---

## Description

Implement the HTTP server setup for the Master API using `net/http`. The server is configurable, supports graceful shutdown, and provides a foundation for registering routes and middleware.

## Acceptance Criteria (verified)

- [x] File `go/internal/server/server.go` exists
- [x] `Server` struct defined with router and configuration dependencies
- [x] `NewServer()` constructor function implemented
- [x] HTTP server configured to listen on configured port
- [x] Server supports graceful shutdown via `context.Context`
- [x] Code follows Go best practices and passes project linter

## Implementation Summary

Implemented `go/internal/server/server.go` with the following features:

- `Server` struct containing `cfg *config.Config`, `db *sql.DB`, `router *http.ServeMux`, and internal `http.Server`.
- `NewServer(cfg, db)` constructor that builds and returns a `*Server`.
- `RegisterRoutes()` which registers `/health` and a placeholder `/api/v1/` route (returns 501 Not Implemented).
- `Start(ctx)` runs the HTTP server with timeouts set (ReadHeaderTimeout, ReadTimeout, WriteTimeout, IdleTimeout) and performs graceful shutdown with a 30s timeout when `ctx` is cancelled.
- Minimal `/health` handler that returns JSON with UTC timestamp.

Linting and formatting:

- Run `make lint` in `go/` after implementation — zero linter issues.

Files changed/added:

- `go/internal/server/server.go` — main server implementation
- Minor formatting fixes applied to `go/internal/config/*` during earlier steps

How to run locally:

```bash
cd /home/user/code/garnizeh/eth-scanner/go
# Provide env vars or rely on Makefile defaults
MASTER_PORT=8080 MASTER_DB_PATH=./data/eth-scanner.db MASTER_LOG_LEVEL=info make run-master
```

How to test:

- After server is running, verify health:

```bash
curl http://localhost:8080/health
```

Expected response:

```json
{"status":"ok","timestamp":"2026-02-14T12:34:56Z"}
```

## Notes

- This implementation uses `net/http.ServeMux` for simplicity (MVP). Future tasks may swap to `chi` or add middleware chaining.
- Server timeouts were set to mitigate slowloris risks and satisfy linter checks.
- Next: implement route handlers and middleware (P03-T030, P03-T040, and Phase 4 endpoints).
