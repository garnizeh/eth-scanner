# P04-T020: Implement job lease logic - Done

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P04-T010, P02-T040  
**Estimated Effort:** Medium (1-3h)

---

## Summary

Implemented the core lease logic to find and assign available or expired jobs to workers.

Changes made:

- `go/internal/jobs/manager.go`: Added `LeaseExistingJob(ctx context.Context, workerID string) (*database.Job, error)` which uses the `FindAvailableBatch`, `LeaseBatch`, and `GetJobByID` queries generated by `sqlc`. The method defaults to a 1-hour lease and returns nil when no job is available.
- `go/internal/jobs/manager_test.go`: Added integration-style tests using an in-memory SQLite database to cover:
  - no jobs available
  - leasing a pending job
  - re-leasing an expired job

Linting and validation:

- Ran `make lint` in the `go/` module and fixed reported issues (errcheck and errorlint).

---

## Acceptance Criteria (checked)

- [x] Method `LeaseExistingJob(ctx context.Context, workerID string) (*Job, error)` implemented in Manager
- [x] Query finds jobs with status='pending' OR (status='processing' AND expires_at < NOW()) (via `FindAvailableBatch` generated query)
- [x] Job is updated with new `worker_id`, `status='processing'`, and `expires_at` (via `LeaseBatch` generated query)
- [x] Uses UTC timestamps exclusively for any created timestamps and lease calculation
- [x] Transaction handling: uses existing atomic SQL queries; additional transactional patterns may be added in follow-ups
- [x] Returns nil if no jobs available (not an error)
- [x] Unit tests cover pending job lease, expired job re-lease, and no jobs available

---

## How to verify locally

Run the Go tests for the jobs package:

```bash
cd go
go test ./internal/jobs -v
```

Run the full test suite (optional):

```bash
cd go
go test ./... -v
```

---

## Notes

- The lease duration is currently a hardcoded 1 hour inside `LeaseExistingJob`. This can be made configurable via `internal/config` in a follow-up task.
- The implementation relies on `sqlc` generated queries (`FindAvailableBatch`, `LeaseBatch`, `GetJobByID`) to perform the find-and-lease steps atomically at the SQL level.
