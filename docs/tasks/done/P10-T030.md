# P10-T030: Implement WebSocket hub in Master API for real-time metrics broadcast

**Phase:** P10 - Dashboard & Monitoring UI  
**Status:** Completed  
**Priority:** High  
**Dependencies:** [P10-T020]  
**Estimated Effort:** Medium

---

## Description

Create a centralized WebSocket hub to broadcast real-time updates to connected dashboard clients. Instead of polling, the server will push updates whenever a worker checkpoints or completes a job.

## Acceptance Criteria

- [x] Implement a `Hub` struct to manage active WebSocket connections.
- [x] Create an endpoint `/api/v1/ws` for dashboard clients to connect.
- [x] Integrate the hub with the `checkpoint` and `complete` handlers to trigger broadcasts.
- [x] Implement a background "heartbeat" broadcast every 5-10 seconds for general fleet stats.
- [x] Support HTMX WebSocket extension protocols for easy fragment swapping.

## Implementation Notes

- Use `github.com/gorilla/websocket`.
- The Hub should handle client registration, unregistration, and broadcoast via channels.
- Ensure the WebSocket route is also protected by the UI authentication logic (check session cookie).

## Testing

- Verify WebSocket connection upgrade in browser.
- Simulate worker activity and observe data being pushed to the client.
- Verify connections are cleaned up when the client disconnects.

## References

- SDD: Real-time monitoring requirements
- [htmx ws extension](https://htmx.org/extensions/web-sockets/)
