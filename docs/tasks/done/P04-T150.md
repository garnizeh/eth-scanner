# P04-T150: Write integration tests for complete endpoint

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Completed
**Priority:** Medium  
**Dependencies:** P04-T090  
**Estimated Effort:** Medium (1-3h)

---

## Description

Created integration tests for the job completion endpoint verifying worker validation, final_nonce validation, and status transitions.

---

## Acceptance Criteria (verified)

- [x] Test file `internal/server/jobs_complete_test.go` created
- [x] Test: Successful completion (status â†’ completed, completed_at set)
- [x] Test: Worker_id mismatch returns 403 Forbidden
- [x] Test: final_nonce != nonce_end returns 400 Bad Request
- [x] Test: Completing non-existent job returns 404
- [x] Test: Completing already completed job returns 400
- [x] Test: Completing pending job (not assigned) returns 400
- [x] Test: completed_at timestamp is UTC
- [x] All tests use `t.TempDir()` for temporary database

---

## Implementation notes

- Tests added at `go/internal/server/jobs_complete_test.go` using `setupServerWithDB` (file-backed DB via `t.TempDir()`), `httptest.NewServer`, and real HTTP requests.
- Tests validate DB state via `database.Queries` and assert timestamp UTC.

---

## How verified

Ran the tests:

```bash
cd go
go test ./internal/server -run TestJobComplete -v
```

All tests passed locally.
