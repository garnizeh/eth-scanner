# P09-T070: Test checkpoint recovery (worker crashes mid-batch)

**Phase:** P09 - Integration, Testing & Validation  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P06-T080  
**Estimated Effort:** Medium

---

## Description

Perform a scenario-based test where a worker crashes mid-batch and resumes work from the last successful checkpoint saved to the Master API.

## Acceptance Criteria

- [x] PC worker starts, leases a job, and updates its progress checkpoint.
- [x] PC worker service/process is killed manually or via signal. (Simulated in E2E test by canceling context and starting new worker instance).
- [x] PC worker restarts, requests a job, and receives its own previous job if it's still processing/leased. (Ensured by server-side `LeaseExistingJob` check).
- [x] PC worker resumes scanning from the last checkpointed nonce. (Verified by checking scan range start in logs).

## Implementation Notes

- Added `CurrentNonce` to `worker.JobLease` and `worker.leaseResponse` in `go/internal/worker/client.go`.
- Updated `worker.Worker.processBatch` in `go/internal/worker/worker.go` to resume from the checkpointed nonce.
- Enhanced `jobs.Manager.LeaseExistingJob` in `go/internal/jobs/manager.go` to return an active job assigned to the same worker if it hasn't expired yet.
- Created `go/internal/server/e2e_worker_crash_recovery_test.go` to validate the full flow.

## Testing

- New E2E test: `TestWorkerCrashRecovery` in `go/internal/server/e2e_worker_crash_recovery_test.go`.

## References

- OVERVIEW: Phase 09 section.
- SDD: Section 4 (Lease System).
