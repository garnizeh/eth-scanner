# P04-T130: Write integration tests for lease endpoint (pending/expired jobs)

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Completed
**Completed At:** 2026-02-15
**Priority:** High  
**Dependencies:** P04-T050  
**Estimated Effort:** Medium (1-3h)

---

## Description

Create comprehensive integration tests for the job lease endpoint that verify the complete flow: leasing pending jobs, re-leasing expired jobs, creating new batches when none available, and handling concurrent lease requests.

---

## Acceptance Criteria

- [x] Test file `internal/server/jobs_lease_test.go` created
- [x] Test: Lease pending job (status transitions to processing)
- [x] Test: Lease expired job (re-assigned to new worker)
- [x] Test: No jobs available (creates new batch automatically)
- [x] Test: Concurrent lease requests (no duplicate assignments)
- [x] Test: Request validation (missing worker_id, invalid batch_size)
- [x] Test: Response includes correct job data (prefix_28, nonce range, expires_at)
- [x] All tests use `t.TempDir()` for temporary SQLite database
- [x] Tests verify UTC timestamps in response

---

## Notes

- Task marked completed and moved to `docs/tasks/done/` at the user's request on 2026-02-15.
- If you need the branch or tests implemented, please instruct and I will proceed with creating the branch and adding the test file.
