# P07-T050: Initialize NVS (Non-Volatile Storage) and obtain partition handles

**Phase:** P07 - ESP32 Worker - Core Infrastructure  
**Status:** Completed  
**Priority:** High  
**Dependencies:** P07-T010  
**Estimated Effort:** Small

---

## Description

Initialize ESP32 Non-Volatile Storage (NVS) subsystem and obtain partition handles for persistent job state storage. This enables checkpoint recovery after power loss or crash.

## Acceptance Criteria

- [x] NVS flash initialized successfully in `app_main()`
- [x] NVS partition handle opened for "storage" namespace
- [x] Error handling for NVS initialization failures
- [x] NVS handle stored in global state for reuse
- [x] NVS statistics logged (used/free space)

## Implementation Notes

**File:** Update `esp32/src/main.c` and create `esp32/src/nvs_handler.c`

**Initialization in `app_main()`:**
```c
#include "nvs_flash.h"

void app_main(void)
{
    // Initialize NVS
    esp_err_t ret = nvs_flash_init();
    if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) {
        // NVS partition was truncated, erase and retry
        ESP_ERROR_CHECK(nvs_flash_erase());
        ret = nvs_flash_init();
    }
    ESP_ERROR_CHECK(ret);
    
    ESP_LOGI(TAG, "NVS initialized successfully");
    
    // Open NVS handle
    nvs_handle_t nvs_handle;
    ret = nvs_open("storage", NVS_READWRITE, &nvs_handle);
    if (ret != ESP_OK) {
        ESP_LOGE(TAG, "Error opening NVS handle: %s", esp_err_to_name(ret));
        return;
    }
    
    // Store handle in global state for subsequent tasks
    g_nvs_handle = nvs_handle;
    
    // Log NVS statistics
    nvs_stats_t nvs_stats;
    nvs_get_stats(NULL, &nvs_stats);
    ESP_LOGI(TAG, "NVS - Used: %d, Free: %d, Total: %d", 
             nvs_stats.used_entries, nvs_stats.free_entries, nvs_stats.total_entries);
}
```

**Global state structure:**
```c
// esp32/include/global_state.h
#ifndef GLOBAL_STATE_H
#define GLOBAL_STATE_H

#include "nvs_flash.h"

typedef struct {
    nvs_handle_t nvs_handle;
    // More state fields will be added in subsequent tasks
} global_state_t;

extern global_state_t g_state;

#endif
```

**NVS namespace naming:**
- Use "storage" namespace for job state (prefix, nonces, etc.)
- Use "config" namespace for device configuration (future use)

**Error recovery:**
- If NVS init fails with `ESP_ERR_NVS_NO_FREE_PAGES`, erase and retry
- If open fails, log error and halt (cannot function without NVS)

## Testing

- Flash firmware and verify "NVS initialized successfully" in log
- Check NVS statistics logged correctly
- Force NVS corruption (fill partition) and verify erase/retry logic
- Verify NVS handle accessible from other modules

## References

- SDD: `docs/architecture/system-design-document.md` (Checkpoint Recovery)
- ESP-IDF NVS: https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html
- Related tasks: P07-T060 (save_checkpoint will use this handle)
