# P06-T090: Implement context cancellation for lease expiration

**Phase:** P06 - PC Worker - Crypto & Scanning Engine  
**Status:** Done
**Completed:** 2026-02-16
**Priority:** High
**Dependencies:** P06-T050
**Effort:** Medium (1-3h)

---

## Summary

Implemented automatic context cancellation before the master-side lease expiry so the worker can checkpoint and shut down gracefully. Changes are implemented in `go/internal/worker/worker.go` and configuration added to `go/internal/worker/config.go`.

Key changes:
- Added `LeaseGracePeriod time.Duration` to `Config` (default: 30s) so the grace period can be tuned.
- In `processBatch`, a scanning context is created with deadline `expires_at - LeaseGracePeriod` to ensure the worker stops scanning early enough to send a final checkpoint.
- The checkpoint goroutine now sends a final checkpoint (using a background context with timeout) when the lease context is done.
- Unit tests updated to exercise grace-period cancellation (`go/internal/worker/worker_test.go`).

## Acceptance Criteria

- [x] Worker calculates time until lease expiration and applies a grace period
- [x] Context with deadline is created: `expires_at - gracePeriod`
- [x] Scanner respects context deadline and stops when reached (scanners already check ctx)
- [x] Final checkpoint is sent before exiting (implemented in checkpoint goroutine)
- [x] Worker logs lease expiration and returns to main loop (processBatch returns on deadline exceeded)
- [x] Unit tests verify behavior

## Notes

- Default grace period is 30 seconds and can be overridden via `Config.LeaseGracePeriod`.
- A follow-up could add tighter integration between `Scanner` and `processBatch` to avoid duplicate progress tracking.
