# P03-T080: Implement graceful shutdown with context.Context

**Phase:** P03 - Master API - Core Infrastructure  
**Status:** Done
**Priority:** Medium  
**Dependencies:** P03-T060  
**Estimated Effort:** Small

---

## Description

Enhance the Master API server with robust graceful shutdown capabilities using `context.Context`. Ensure all in-flight requests complete, database connections close properly, and resources are cleaned up before the application exits.

## Acceptance Criteria

- [x] Server uses `http.Server.Shutdown()` for graceful termination
- [x] Context cancellation propagates to all goroutines
- [x] In-flight HTTP requests are allowed to complete (with timeout)
- [x] Database connections are closed before exit
- [x] Shutdown timeout is configurable (default: 30 seconds)
- [x] Shutdown process is logged with clear messages
- [x] No goroutine leaks after shutdown

## Implementation Notes

The server's `Start` implementation uses `http.Server.Shutdown()` with a configurable timeout (`Config.ShutdownTimeout`, default 30s). A context-aware listener (`net.ListenConfig.Listen`) is used, in-flight requests are awaited during shutdown, and active connections are force-closed if the shutdown deadline is exceeded. The DB is closed via `RegisterOnShutdown` and again before `Start` returns to ensure determinism for tests.

## Testing

Automated tests cover graceful shutdown, in-flight request handling, forced shutdown on timeout, and DB closure. The `internal/server/server_test.go` file contains tests exercising these flows.

Manual verification steps (same as in backlog):

```bash
cd /home/user/code/garnizeh/eth-scanner/go

# Test 1: Graceful shutdown with no traffic
./bin/master &
PID=$!
sleep 2
kill -SIGTERM $PID
wait $PID

# Test 2: Graceful shutdown with active request
./bin/master &
PID=$!
# Send long-running request in background
curl http://localhost:8080/health &
sleep 1
kill -SIGTERM $PID
# Server should wait for curl to complete
```

## Notes

- Linter: `make lint` (run from `go/`) reports 0 issues after the recent fixes.
- Branch with the completion commit: `task/P03-T080-graceful-shutdown`.

## Completion

- Completed on: 2026-02-15
- Completed in branch: `task/P03-T080-graceful-shutdown`
