# P04-T070: Create PATCH /api/v1/jobs/{id}/checkpoint handler

**Phase:** P04 - Master API - Job Management (Dynamic Batching)  
**Status:** Done
**Priority:** High  
**Completed On:** 2026-02-15

## Summary

Implemented the checkpoint endpoint that allows workers to report progress on their assigned job. Added server handler, routing, database update logic, and unit tests covering success, worker mismatch (403), not found (404), and method-not-allowed (405).

## Acceptance Criteria (completed)
- [x] Handler `handleJobCheckpoint` implemented
- [x] Accepts PATCH request to `/api/v1/jobs/{id}/checkpoint`
- [x] Request body: `{"worker_id": "...", "current_nonce": 12345, "keys_scanned": 12345}`
- [x] Validates job exists and is in `processing` status
- [x] Validates `worker_id` matches the job's assigned worker
- [x] Updates job: `current_nonce`, `keys_scanned`, `updated_at` (UTC)
- [x] Returns 200 OK with updated job on success
- [x] Returns 403 Forbidden if worker_id mismatch
- [x] Returns 404 Not Found if job doesn't exist
- [x] Route registered in `routes.go`

## Implementation notes

- Files changed:
  - `go/internal/server/checkpoint.go` — handler implementation
  - `go/internal/server/routes.go` — route dispatching and 405 handling for checkpoint path
  - `go/internal/server/checkpoint_test.go` — unit tests (success, mismatch, not found, method not allowed)
- Linting: addressed `errors.Is` usage and removed an empty branch reported by linters.
- Tests: full `make test` passed locally after changes.

## References

- Database queries: `go/internal/database/sql/queries.sql`
- Related tasks: P04-T050 (job lease), P04-T060 (UTC timestamps)

## Follow-up

- (Optional) Open PR with branch `task/P04-T070-create-checkpoint-handler` and include this done task file in the commit.
