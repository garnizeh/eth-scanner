# A01-T050: Implement multi-tier worker statistics tables with automatic aggregation

**Phase:** A01 - Performance & Optimization (Adhoc)  
**Status:** Done  
**Priority:** High  
**Dependencies:** A01-T040  
**Estimated Effort:** Large (3h+)

---

## Summary

Implemented a four-tier worker statistics architecture (history → daily → monthly → lifetime) with SQLite triggers that aggregate and prune per-worker data. Added sqlc queries, unit tests, and updated the schema.

What was changed and verified
- Schema: `go/internal/database/sql/001_schema.sql` — added `worker_history`, `worker_stats_daily`, `worker_stats_monthly`, `worker_stats_lifetime`, indexes, and triggers.
- Queries: `go/internal/database/sql/queries.sql` — added `RecordWorkerStats`, `GetRecentWorkerHistory`, `GetWorkerDailyStats`, `GetWorkerMonthlyStats`, `GetWorkerLifetimeStats`, and related queries. `GetWorkerDailyStats` now truncates incoming timestamp to `YYYY-MM-DD` for robustness.
- Generated code: ran `sqlc` and updated generated files under `go/internal/database/` (e.g., `queries.sql.go`, `models.go`).
- Tests: `go/internal/database/stats_test.go` — unit tests added for aggregation and per-worker pruning. All database package tests pass locally.

Verification
- Ran: `make sqlc` (success)
- Ran: `go test ./internal/database -v` — all tests in the package passed.

Notes
- The `GetWorkerDailyStats` query was adapted so callers may pass a `time.Time` and the query will compare only the `YYYY-MM-DD` portion, preventing mismatch issues.

---

## Acceptance Criteria (completed)
- [x] Add `worker_history` table to `internal/database/sql/001_schema.sql`
- [x] Add `worker_stats_daily` table for daily aggregation per worker
- [x] Add `worker_stats_monthly` table for monthly aggregation per worker
- [x] Add `worker_stats_lifetime` table for cumulative totals
- [x] Add indexes for all tables (worker_id, dates, worker_type)
- [x] Implement `aggregate_before_prune_history` trigger (history → daily/monthly/lifetime)
- [x] Implement `prune_daily_stats_per_worker` trigger (cap at 1000 per worker_id)
- [x] Implement `prune_monthly_stats_per_worker` trigger (cap at 1000 per worker_id)
- [x] Add sqlc queries for inserting stats at all tiers
- [x] Add sqlc queries for dashboard data retrieval (recent, daily, monthly, lifetime)
- [x] Run `sqlc generate` and verify generated code
- [x] Write unit tests for stats insertion at each tier
- [x] Write unit tests verifying retention limits work per worker (not globally)
- [x] Write unit tests verifying automatic aggregation triggers fire correctly

---

If you want, I can open a PR for `task/A01-T050-implement-worker-stats` with these changes and a brief description of the verification steps.
