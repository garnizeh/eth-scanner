# P07-T070: Implement load_checkpoint() to restore state during app_main boot sequence

**Phase:** P07 - ESP32 Worker - Core Infrastructure  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P07-T060  
**Estimated Effort:** Medium

---

## Description

Implement `load_checkpoint()` function to restore job state from NVS during ESP32 boot sequence. This enables seamless recovery from power loss or crash, resuming work from the last saved checkpoint.

## Acceptance Criteria

- [x] `load_checkpoint()` function implemented
- [x] Validates checkpoint magic number before use
- [x] Returns error if no checkpoint exists or checkpoint invalid
- [x] Populates global state with restored job info
- [x] Checks checkpoint staleness (timestamp validation)
- [x] Called early in `app_main()` boot sequence

## Implementation Notes

**File:** `esp32/src/nvs_handler.c`

**Implementation:**
```c
#define CHECKPOINT_MAX_AGE_SEC (3600 * 2)  // 2 hours staleness limit

esp_err_t load_checkpoint(nvs_handle_t handle, job_checkpoint_t* out_checkpoint)
{
    if (out_checkpoint == NULL) {
        return ESP_ERR_INVALID_ARG;
    }
    
    size_t required_size = sizeof(job_checkpoint_t);
    esp_err_t err = nvs_get_blob(handle, NVS_CHECKPOINT_KEY, 
                                 out_checkpoint, &required_size);
    
    if (err == ESP_ERR_NVS_NOT_FOUND) {
        ESP_LOGI(TAG, "No checkpoint found in NVS");
        return ESP_ERR_NOT_FOUND;
    } else if (err != ESP_OK) {
        ESP_LOGE(TAG, "Error reading checkpoint: %s", esp_err_to_name(err));
        return err;
    }
    
    // Validate magic number
    if (out_checkpoint->magic != CHECKPOINT_MAGIC) {
        ESP_LOGW(TAG, "Invalid checkpoint magic: 0x%08X", out_checkpoint->magic);
        return ESP_ERR_INVALID_CRC;
    }
    
    // Check staleness (prevent resuming very old jobs)
    uint64_t now = esp_timer_get_time() / 1000000ULL;
    uint64_t age = now - out_checkpoint->timestamp;
    if (age > CHECKPOINT_MAX_AGE_SEC) {
        ESP_LOGW(TAG, "Checkpoint too old (%llu sec), discarding", age);
        return ESP_ERR_INVALID_STATE;
    }
    
    ESP_LOGI(TAG, "Checkpoint loaded: job_id=%lld, current_nonce=%llu", 
             out_checkpoint->job_id, out_checkpoint->current_nonce);
    
    return ESP_OK;
}
```

**Integration in `app_main()`:**
```c
void app_main(void)
{
    // ... NVS init, WiFi init ...
    
    // Attempt to load checkpoint
    job_checkpoint_t checkpoint;
    esp_err_t err = load_checkpoint(g_state.nvs_handle, &checkpoint);
    
    if (err == ESP_OK) {
        ESP_LOGI(TAG, "Resuming from checkpoint...");
        
        // Verify job still valid with Master API (optional)
        job_info_t job_info;
        if (api_verify_job(checkpoint.job_id, &job_info) == ESP_OK) {
            // Restore state
            g_state.current_job = job_info;
            atomic_store(&g_state.current_nonce, checkpoint.current_nonce);
            atomic_store(&g_state.keys_scanned, checkpoint.keys_scanned);
            
            ESP_LOGI(TAG, "State restored, resuming from nonce %llu", 
                     checkpoint.current_nonce);
        } else {
            ESP_LOGW(TAG, "Job no longer valid, will lease new job");
            err = ESP_ERR_NOT_FOUND;  // Force new lease
        }
    }
    
    if (err != ESP_OK) {
        ESP_LOGI(TAG, "Starting fresh, will lease new job");
        // Continue normal lease flow
    }
    
    // ... Start worker tasks ...
}
```

**Staleness handling:**
- Checkpoints older than 2 hours are discarded
- Prevents resuming jobs with expired leases
- Master API will reassign if lease expired

**Edge cases:**
- No checkpoint exists → lease new job (normal first boot)
- Invalid magic → log warning, lease new job
- Checkpoint too old → discard, lease new job
- Job no longer exists on Master → discard, lease new job

## Testing

- Save checkpoint, restart ESP32, verify state restored
- Save checkpoint, wait >2 hours, restart, verify discarded
- Corrupt checkpoint in NVS, restart, verify graceful fallback
- Delete checkpoint key, restart, verify normal lease flow
- Test with invalid magic number

## References

- SDD: `docs/architecture/system-design-document.md` (Checkpoint Recovery)
- ESP-IDF NVS: https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html
- Related tasks: P08-T060 (checkpoint timer will call save periodically)
