# P07-T100: Define Global State struct in shared_types.h

**Phase:** P07 - ESP32 Worker - Core Infrastructure  
**Status:** Not Started  
**Priority:** High  
**Dependencies:** P07-T010  
**Estimated Effort:** Small

---

## Description

Define comprehensive global state structure in `shared_types.h` to hold all runtime state (job info, nonce counters, NVS handle, configuration). This provides a single source of truth shared across all tasks and modules.

## Acceptance Criteria

- [x] `shared_types.h` header file created
- [x] `global_state_t` struct defined with all required fields
- [x] `job_info_t` struct defined for current job
- [x] Atomic counters for current_nonce and keys_scanned
- [x] Global state instance declared (`extern global_state_t g_state`)
- [x] Global state initialized in `main.c`

## Implementation Notes

**File:** `esp32/include/shared_types.h`

```c
#ifndef SHARED_TYPES_H
#define SHARED_TYPES_H

#include <stdint.h>
#include <stdbool.h>
#include "nvs.h"
#include "freertos/FreeRTOS.h"
#include "freertos/atomic.h"

// Constants
#define PREFIX_28_SIZE 28
#define ETH_ADDRESS_SIZE 20
#define WORKER_ID_MAX_LEN 32

// Job information structure
typedef struct {
    int64_t job_id;
    uint8_t prefix_28[PREFIX_28_SIZE];
    uint64_t nonce_start;
    uint64_t nonce_end;
    uint8_t target_address[ETH_ADDRESS_SIZE];
    int64_t expires_at;  // Unix timestamp
} job_info_t;

// Checkpoint structure (for NVS persistence)
typedef struct {
    int64_t job_id;
    uint8_t prefix_28[PREFIX_28_SIZE];
    uint64_t nonce_start;
    uint64_t nonce_end;
    uint64_t current_nonce;
    uint64_t keys_scanned;
    uint64_t timestamp;
    uint32_t magic;
} job_checkpoint_t;

// Worker statistics
typedef struct {
    uint32_t keys_per_second;     // Measured throughput
    uint32_t total_jobs_completed;
    uint64_t total_keys_scanned;
    uint64_t uptime_seconds;
} worker_stats_t;

// Global state structure
typedef struct {
    // NVS handle
    nvs_handle_t nvs_handle;
    
    // Current job information
    job_info_t current_job;
    bool job_active;
    
    // Atomic progress counters (accessed from Core 1 hot loop)
    atomic_ullong current_nonce;   // Current nonce being processed
    atomic_ullong keys_scanned;    // Keys scanned in current batch
    
    // Worker identification
    char worker_id[WORKER_ID_MAX_LEN];
    
    // Performance metrics
    worker_stats_t stats;
    
    // Task synchronization
    TaskHandle_t core0_task_handle;
    TaskHandle_t core1_task_handle;
    
    // Checkpoint timer
    TimerHandle_t checkpoint_timer;
    
    // State flags
    volatile bool wifi_connected;
    volatile bool should_stop;     // Signal worker to stop
    
} global_state_t;

// Global state instance (defined in main.c)
extern global_state_t g_state;

#endif // SHARED_TYPES_H
```

**Initialization in `main.c`:**
```c
#include "shared_types.h"

// Define global state instance
global_state_t g_state = {0};

void app_main(void)
{
    // Initialize global state
    memset(&g_state, 0, sizeof(global_state_t));
    
    // Set worker ID from config
    strncpy(g_state.worker_id, CONFIG_ETHSCANNER_WORKER_ID, WORKER_ID_MAX_LEN - 1);
    
    // Initialize atomic counters
    atomic_init(&g_state.current_nonce, 0);
    atomic_init(&g_state.keys_scanned, 0);
    
    ESP_LOGI(TAG, "Global state initialized");
    
    // ... Continue with initialization ...
}
```

**Usage examples:**

**Core 0 (Network) task:**
```c
// Update job info after lease
g_state.current_job = leased_job;
g_state.job_active = true;
atomic_store(&g_state.current_nonce, leased_job.nonce_start);
```

**Core 1 (Worker) task:**
```c
// Hot loop
while (atomic_load(&g_state.current_nonce) < g_state.current_job.nonce_end) {
    uint64_t nonce = atomic_fetch_add(&g_state.current_nonce, 1);
    // ... crypto operations ...
    atomic_fetch_add(&g_state.keys_scanned, 1);
}
```

**Checkpoint task:**
```c
// Read current state
uint64_t nonce = atomic_load(&g_state.current_nonce);
uint64_t scanned = atomic_load(&g_state.keys_scanned);

// Save checkpoint
job_checkpoint_t ckpt = {
    .job_id = g_state.current_job.job_id,
    .current_nonce = nonce,
    .keys_scanned = scanned,
    // ...
};
save_checkpoint(g_state.nvs_handle, &ckpt);
```

## Testing

- Compile project and verify no errors
- Verify global state accessible from multiple source files
- Test atomic operations on counters from different tasks
- Verify sizeof(global_state_t) reasonable (<1KB)
- Use `extern` declaration in other modules and verify linkage

## References

- SDD: `docs/architecture/system-design-document.md` (Architecture Overview)
- FreeRTOS Atomic: https://www.freertos.org/FreeRTOS_Support_Forum_Archive/November_2017/freertos_Atomic_Operations_4e01e5e3j.html
- Related tasks: All P08 tasks will use this global state
